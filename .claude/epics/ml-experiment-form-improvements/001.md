---
task_id: 001
title: Database models and migrations for template system
type: backend
status: pending
priority: high
effort: 16
parallel: true
depends_on: []
created: 2025-08-21T20:56:15Z
updated: 2025-08-21T20:56:15Z
assignee: null
github_issue: null
---

# Task #001: Database models and migrations for template system

**Epic**: ml-experiment-form-improvements  
**Status**: üîÑ PENDING  
**Duration**: 16 hours (2 days)  
**Type**: Backend Foundation  

## üéØ Objective

Create the foundational database models and migrations required for the ML experiment template system, including the new `experiment_templates` table and extending the existing `ml_experiments` model with enhanced metadata fields.

## üìã Requirements

### Primary Deliverables

1. **ExperimentTemplate Model**
   - JSON configuration storage for reusable experiment templates
   - Version control and audit trail support
   - User ownership and sharing capabilities
   - Template categorization and tagging system

2. **ML Experiments Model Extensions**
   - Rich metadata fields for experiment tracking
   - Template association and inheritance tracking
   - Enhanced configuration storage
   - Backward compatibility with existing experiments

3. **Database Migrations**
   - Safe migration strategy for existing data
   - Index optimization for performance
   - Foreign key relationships and constraints
   - Data integrity validations

## üîß Technical Implementation

### Database Schema Design

#### ExperimentTemplate Model
```python
class ExperimentTemplate(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    name = models.CharField(max_length=255)
    description = models.TextField(blank=True)
    category = models.CharField(max_length=100, choices=TEMPLATE_CATEGORIES)
    tags = models.JSONField(default=list)
    
    # Configuration Storage
    configuration = models.JSONField()
    version = models.PositiveIntegerField(default=1)
    is_active = models.BooleanField(default=True)
    
    # Ownership and Permissions
    created_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='created_templates')
    is_public = models.BooleanField(default=False)
    shared_with = models.ManyToManyField(User, blank=True, related_name='shared_templates')
    
    # Usage Tracking
    usage_count = models.PositiveIntegerField(default=0)
    last_used = models.DateTimeField(null=True, blank=True)
    
    # Metadata
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'experiment_templates'
        ordering = ['-updated_at']
        indexes = [
            models.Index(fields=['category', 'is_active']),
            models.Index(fields=['created_by', 'is_public']),
            models.Index(fields=['-usage_count']),
        ]
```

#### ML Experiments Model Extensions
```python
# Add to existing MLExperiment model
class MLExperiment(models.Model):
    # ... existing fields ...
    
    # Template Association
    template = models.ForeignKey(
        ExperimentTemplate, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name='experiments'
    )
    template_version = models.PositiveIntegerField(null=True, blank=True)
    
    # Enhanced Metadata
    configuration_metadata = models.JSONField(default=dict)
    dataset_statistics = models.JSONField(default=dict)
    feature_importance = models.JSONField(default=dict)
    model_recommendations = models.JSONField(default=dict)
    
    # Wizard State Tracking
    wizard_completed = models.BooleanField(default=False)
    wizard_step_completed = models.PositiveIntegerField(default=0)
    wizard_state = models.JSONField(default=dict)
    
    # Performance Tracking
    estimated_training_time = models.DurationField(null=True, blank=True)
    actual_training_time = models.DurationField(null=True, blank=True)
    resource_requirements = models.JSONField(default=dict)
```

### Migration Strategy

#### Migration 001: Create ExperimentTemplate
```python
# migrations/001_create_experiment_template.py
class Migration(migrations.Migration):
    dependencies = [
        ('ml', '0024_previous_migration'),
    ]
    
    operations = [
        migrations.CreateModel(
            name='ExperimentTemplate',
            fields=[
                # Model fields as defined above
            ],
            options={
                'db_table': 'experiment_templates',
                'ordering': ['-updated_at'],
            },
        ),
        migrations.AddIndex(
            model_name='experimenttemplate',
            index=models.Index(fields=['category', 'is_active'], name='exp_tmpl_cat_active_idx'),
        ),
        # Additional indexes...
    ]
```

#### Migration 002: Extend MLExperiment
```python
# migrations/002_extend_ml_experiment.py
class Migration(migrations.Migration):
    dependencies = [
        ('ml', '001_create_experiment_template'),
    ]
    
    operations = [
        migrations.AddField(
            model_name='mlexperiment',
            name='template',
            field=models.ForeignKey(
                null=True, blank=True,
                on_delete=models.SET_NULL,
                related_name='experiments',
                to='ml.experimenttemplate'
            ),
        ),
        # Additional fields...
        migrations.AddIndex(
            model_name='mlexperiment',
            index=models.Index(fields=['template', 'created_at'], name='ml_exp_template_created_idx'),
        ),
    ]
```

### Validation and Constraints

#### Configuration Schema Validation
```python
# validators.py
import jsonschema

EXPERIMENT_CONFIG_SCHEMA = {
    "type": "object",
    "properties": {
        "dataset": {"type": "object"},
        "features": {"type": "array"},
        "model": {"type": "object"},
        "parameters": {"type": "object"},
        "validation": {"type": "object"}
    },
    "required": ["dataset", "features", "model"]
}

def validate_experiment_configuration(config):
    try:
        jsonschema.validate(config, EXPERIMENT_CONFIG_SCHEMA)
        return True, None
    except jsonschema.ValidationError as e:
        return False, str(e)
```

## üß™ Testing Requirements

### Unit Tests
```python
# tests/test_models.py
class ExperimentTemplateModelTest(TestCase):
    def test_template_creation(self):
        """Test basic template creation and validation"""
        
    def test_configuration_validation(self):
        """Test JSON schema validation for configuration"""
        
    def test_version_increment(self):
        """Test automatic version incrementing"""
        
    def test_usage_tracking(self):
        """Test usage count and last_used updates"""

class MLExperimentExtensionTest(TestCase):
    def test_template_association(self):
        """Test template linking to experiments"""
        
    def test_metadata_storage(self):
        """Test enhanced metadata field storage"""
        
    def test_wizard_state_persistence(self):
        """Test wizard state tracking"""
```

### Migration Tests
```python
# tests/test_migrations.py
class MigrationTest(TransactionTestCase):
    def test_template_migration_forward(self):
        """Test forward migration creates tables correctly"""
        
    def test_experiment_extension_migration(self):
        """Test ML experiment model extension"""
        
    def test_data_integrity_after_migration(self):
        """Test existing experiment data remains intact"""
```

## üìä Performance Considerations

### Database Optimization
- **Indexes**: Optimized for common query patterns (category, ownership, usage)
- **JSON Field Queries**: Use PostgreSQL JSON operators for efficient filtering
- **Foreign Key Constraints**: Proper cascading deletes and SET_NULL for data integrity
- **Partitioning**: Consider partitioning for high-volume template usage

### Query Optimization
```python
# Efficient template queries
templates = ExperimentTemplate.objects.select_related('created_by')\
    .prefetch_related('shared_with')\
    .filter(category='classification', is_active=True)\
    .order_by('-usage_count')

# Experiment queries with template data
experiments = MLExperiment.objects.select_related('template')\
    .filter(template__category='regression')\
    .only('name', 'created_at', 'template__name')
```

## üîç Acceptance Criteria

### Functional Requirements
- [ ] ExperimentTemplate model created with all specified fields
- [ ] MLExperiment model extended with metadata and template fields
- [ ] Database migrations run successfully without data loss
- [ ] JSON schema validation works for template configurations
- [ ] Template versioning system functions correctly
- [ ] Usage tracking updates automatically

### Performance Requirements
- [ ] Template creation/update operations complete in < 100ms
- [ ] Template queries with filters complete in < 200ms
- [ ] Migration completes in < 30 seconds for existing data
- [ ] No performance degradation in existing experiment operations

### Data Integrity Requirements
- [ ] Foreign key relationships maintain data consistency
- [ ] JSON schema validation prevents invalid configurations
- [ ] Template deletion doesn't break existing experiments
- [ ] User permissions properly enforce template access control

## üöÄ Implementation Plan

### Phase 1: Model Definition (4 hours)
1. Create ExperimentTemplate model with all fields
2. Define JSON schema for configuration validation
3. Add model methods for version management
4. Create model admin interface

### Phase 2: Model Extension (4 hours)
1. Extend MLExperiment model with new fields
2. Add template association logic
3. Create model methods for metadata management
4. Update model admin interface

### Phase 3: Migrations (4 hours)
1. Create ExperimentTemplate migration
2. Create MLExperiment extension migration
3. Add database indexes and constraints
4. Test migration on sample data

### Phase 4: Testing (4 hours)
1. Write comprehensive unit tests
2. Create migration tests
3. Test performance with sample data
4. Validate data integrity

## üîó Dependencies

### Prerequisites
- Existing MLExperiment model must be stable
- User authentication system in place
- PostgreSQL database with JSON field support
- Django migration framework configured

### Blockers
- None identified

### Integration Points
- **Task #002**: API endpoints will use these models
- **Task #003**: Dataset analysis service will populate metadata fields
- **Future Tasks**: Frontend wizard will interact with template system

## üìù Notes

### Design Decisions
- **UUID Primary Keys**: Maintains consistency with existing model patterns
- **JSON Configuration**: Flexible storage for varying experiment types
- **Soft Template Deletion**: Uses `is_active` flag to preserve experiment history
- **Usage Tracking**: Built-in analytics for template popularity

### Migration Safety
- All new fields are optional to maintain backward compatibility
- Foreign keys use SET_NULL to prevent cascading deletions
- Migrations are reversible and data-safe
- Database indexes are added separately to minimize lock time

### Future Extensibility
- Template configuration schema can be versioned independently
- User permission system can be extended for organization-level sharing
- Usage tracking foundation supports future analytics features
- JSON fields allow for flexible metadata expansion