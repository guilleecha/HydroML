# Issue 1: Layout System Refactoring

## Issue Information
- **Issue ID**: 1
- **Epic**: data-tools-enhancement
- **Title**: Layout System Refactoring
- **Status**: Pending
- **Priority**: Critical
- **Assignee**: Claude Code
- **Created**: 2025-01-22
- **Estimated Effort**: 1 day

## Problem Description
Data Studio uses hardcoded absolute positioning that conflicts with the Enhanced Grove Headbar's dynamic height system.

### Current Implementation Issues
```css
/* data_tools/templates/data_tools/data_studio.html:43-54 */
position: absolute;
top: 4rem;  /* PROBLEM: Hardcoded height */
height: calc(100vh - 4rem); /* PROBLEM: Fixed calculation */
```

### Conflicts With
- Grove Enhanced Headbar two-row layout (variable height)
- Responsive design requirements
- Theme switching transitions

## Root Cause Analysis
1. **Hardcoded Values**: `top: 4rem` assumes fixed headbar height
2. **No CSS Variables**: Missing integration with Grove design token system
3. **Absolute Positioning**: Conflicts with Grove's responsive layout approach

## Technical Solution

### 1. CSS Variable Integration
```css
/* NEW: Use Grove headbar height variable */
top: var(--grove-headbar-height, 4rem);
height: calc(100vh - var(--grove-headbar-height, 4rem));
```

### 2. Dynamic Height Detection
```javascript
// NEW: Add headbar height detection
function updateDataStudioLayout() {
    const headbar = document.querySelector('.wave-headbar');
    if (headbar) {
        const height = headbar.offsetHeight;
        document.documentElement.style.setProperty('--grove-headbar-height', `${height}px`);
    }
}
```

### 3. Responsive Layout System
```css
/* NEW: Responsive positioning */
.data-studio-container {
    position: fixed;
    top: var(--grove-headbar-height);
    left: 0;
    right: 0;
    bottom: 0;
    transition: top 0.2s ease;
}
```

## Implementation Steps

### Step 1: Create Backup
```bash
cp data_tools/templates/data_tools/data_studio.html data_tools/templates/data_tools/data_studio.html.backup
```

### Step 2: Create Layout CSS
Create `data_tools/static/data_tools/css/data-studio-layout.css`:
```css
:root {
    --data-studio-headbar-height: 4rem;
    --data-studio-sidebar-width: 280px;
}

.data-studio-container {
    position: fixed;
    top: var(--grove-headbar-height, var(--data-studio-headbar-height));
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: calc(100vh - var(--grove-headbar-height, var(--data-studio-headbar-height)));
    margin: 0;
    padding: 0;
    z-index: 1;
    transition: top 0.2s ease, height 0.2s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .data-studio-container {
        --data-studio-sidebar-width: 240px;
    }
}
```

### Step 3: Update Template
Modify `data_tools/templates/data_tools/data_studio.html`:
```html
{% block extra_css %}
<link rel="stylesheet" href="{% static 'data_tools/css/data-studio-layout.css' %}">
<link rel="stylesheet" href="{% static 'core/css/layouts/data-studio-layout.css' %}">
{% endblock %}

<!-- Replace lines 43-54 with: -->
<div class="data-studio-container flex bg-gray-50 dark:bg-gray-900" 
     x-data="{...dataStudioApp(), showExportHistory: false}" 
     x-init="init(); checkSessionStatus(); updateDataStudioLayout()">
```

### Step 4: Add JavaScript Integration
Add to `data_tools/static/data_tools/js/data_studio.js`:
```javascript
// Headbar height detection and adaptation
function updateDataStudioLayout() {
    const headbar = document.querySelector('.wave-headbar');
    if (headbar) {
        const height = headbar.offsetHeight;
        document.documentElement.style.setProperty('--grove-headbar-height', `${height}px`);
        console.log(`Data Studio adapted to headbar height: ${height}px`);
    }
}

// Listen for headbar changes (theme switching, layout changes)
window.addEventListener('resize', updateDataStudioLayout);
document.addEventListener('DOMContentLoaded', updateDataStudioLayout);

// Theme change detection
const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
            updateDataStudioLayout();
        }
    });
});
observer.observe(document.documentElement, { attributes: true });
```

## Files Modified

### Primary Files
1. **data_tools/templates/data_tools/data_studio.html**
   - Remove hardcoded positioning
   - Add CSS variable integration
   - Include new stylesheet

2. **data_tools/static/data_tools/js/data_studio.js** 
   - Add headbar height detection
   - Implement layout adaptation system

### New Files
1. **data_tools/static/data_tools/css/data-studio-layout.css**
   - Core layout system
   - CSS variable definitions
   - Responsive design rules

## Testing Requirements

### Manual Testing
- [ ] Test with single-row headbar
- [ ] Test with two-row headbar  
- [ ] Test theme switching (light/dark)
- [ ] Test viewport resizing
- [ ] Test mobile responsive layout

### Browser Testing
- [ ] Chrome (latest)
- [ ] Firefox (latest)
- [ ] Safari (latest)
- [ ] Edge (latest)

### Integration Testing
- [ ] Verify no conflicts with existing functionality
- [ ] Test session management still works
- [ ] Verify data grid operates normally
- [ ] Check sidebar interactions

## Acceptance Criteria
- [ ] Zero hardcoded positioning values
- [ ] Adapts to any headbar height automatically
- [ ] Smooth transitions during layout changes
- [ ] No visual glitches or overlap
- [ ] Maintains responsive design principles
- [ ] Performance equivalent to current implementation

## Rollback Plan
If issues arise:
1. Restore backup: `mv data_studio.html.backup data_studio.html`
2. Remove new CSS files
3. Clear browser cache
4. Restart Django server

## Dependencies
- Enhanced Grove Headbar (âœ… Complete)
- Grove CSS variables system
- WaveHeadbar.js height detection

## Related Issues
- Issue 3: Content-Headbar Overlap Resolution (depends on this)
- Issue 6: CSS Architecture Modernization (builds on this)