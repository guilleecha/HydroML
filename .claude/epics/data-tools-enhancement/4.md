# Issue 4: Metrics and Icons Integration

## Issue Information
- **Issue ID**: 4
- **Epic**: data-tools-enhancement
- **Title**: Metrics and Icons Integration
- **Status**: Pending
- **Priority**: Medium
- **Assignee**: Claude Code
- **Created**: 2025-01-22
- **Estimated Effort**: 1 day

## Problem Description
Data Studio currently displays basic statistics in a simple format that doesn't leverage Grove's comprehensive KPI visualization patterns and icon system.

### Current Implementation Issues
```javascript
// data_tools/static/data_tools/js/data_studio_sidebar.js:55-61
// Basic text-only statistics display
updateStats() {
    const rowElement = document.getElementById('sidebar-row-count');
    const columnElement = document.getElementById('sidebar-column-count');
    
    if (rowElement) rowElement.textContent = rowCount.toLocaleString();
    if (columnElement) columnElement.textContent = columnCount.toLocaleString();
}
```

### Grove Pattern Reference
Grove demo showcases rich KPI visualization:
```html
<!-- core/templates/core/grove_demo.html:125-210 -->
<div class="grid grid-cols-6 gap-1 kpi-grid">
    <!-- Total Rows -->
    <div class="bg-white dark:bg-gray-800 rounded-md p-2 border border-gray-200">
        <div class="text-center">
            <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-1">
                <svg class="w-3 h-3 text-blue-600">...</svg>
            </div>
            <p class="text-xs font-medium text-gray-600 mb-1">Rows</p>
            <p class="text-base font-bold text-gray-900">{{ value }}</p>
        </div>
    </div>
    <!-- Additional KPI cards... -->
</div>
```

## Current vs Target Comparison

### Current State (Basic)
- Text-only row/column counts
- No visual hierarchy
- Missing contextual information
- No Grove design integration

### Target State (Grove KPI)
- Rich visual KPI cards
- Contextual icons and colors
- Comprehensive metrics display
- Grove design system integration

## Technical Solution

### 1. Enhanced Metrics System
```javascript
// NEW: Enhanced metrics calculation and display
class DataStudioMetrics {
    constructor(gridManager) {
        this.gridManager = gridManager;
        this.metricsContainer = null;
        this.init();
    }
    
    init() {
        this.createMetricsContainer();
        this.updateMetrics();
    }
    
    createMetricsContainer() {
        const sidebar = document.querySelector('.data-studio-sidebar');
        if (sidebar) {
            this.metricsContainer = document.createElement('div');
            this.metricsContainer.className = 'metrics-grid';
            this.metricsContainer.innerHTML = this.getMetricsGridHTML();
            
            // Insert after status section
            const statusSection = sidebar.querySelector('.sidebar-status');
            if (statusSection) {
                statusSection.after(this.metricsContainer);
            }
        }
    }
    
    getMetricsGridHTML() {
        return `
            <div class="grove-metrics-grid">
                <h3 class="grove-metrics-title">Dataset Overview</h3>
                <div class="grove-kpi-grid">
                    ${this.getKPICard('rows', 'Rows', 'blue', this.getRowsIcon())}
                    ${this.getKPICard('columns', 'Columns', 'purple', this.getColumnsIcon())}
                    ${this.getKPICard('missing', 'Missing', 'red', this.getMissingIcon())}
                    ${this.getKPICard('types', 'Data Types', 'green', this.getTypesIcon())}
                    ${this.getKPICard('memory', 'Memory', 'indigo', this.getMemoryIcon())}
                    ${this.getKPICard('duplicates', 'Duplicates', 'orange', this.getDuplicatesIcon())}
                </div>
            </div>
        `;
    }
    
    getKPICard(id, label, color, icon) {
        return `
            <div class="grove-kpi-card grove-kpi-card--${color}" data-metric="${id}">
                <div class="grove-kpi-icon">
                    <div class="grove-kpi-icon-container grove-kpi-icon--${color}">
                        ${icon}
                    </div>
                </div>
                <div class="grove-kpi-content">
                    <p class="grove-kpi-label">${label}</p>
                    <p class="grove-kpi-value" id="metric-${id}">--</p>
                    <p class="grove-kpi-change" id="metric-${id}-change" style="display: none;">
                        <span class="grove-kpi-change-indicator"></span>
                        <span class="grove-kpi-change-text"></span>
                    </p>
                </div>
            </div>
        `;
    }
    
    updateMetrics() {
        if (!this.gridManager || !this.gridManager.gridApi) return;
        
        const api = this.gridManager.gridApi;
        const metrics = this.calculateMetrics(api);
        
        // Update each KPI card
        Object.entries(metrics).forEach(([key, value]) => {
            this.updateKPIValue(key, value);
        });
    }
    
    calculateMetrics(gridApi) {
        const rowCount = gridApi.getDisplayedRowCount();
        const columnDefs = gridApi.getColumnDefs() || [];
        const columnCount = columnDefs.length;
        
        // Calculate additional metrics from data
        const rowData = [];
        gridApi.forEachNode(node => rowData.push(node.data));
        
        return {
            rows: this.formatNumber(rowCount),
            columns: columnCount,
            missing: this.calculateMissingData(rowData, columnDefs),
            types: this.calculateDataTypes(columnDefs),
            memory: this.estimateMemoryUsage(rowData),
            duplicates: this.calculateDuplicates(rowData)
        };
    }
    
    updateKPIValue(metricId, value) {
        const element = document.getElementById(`metric-${metricId}`);
        if (element) {
            const oldValue = element.textContent;
            element.textContent = value;
            
            // Show change indicator if value changed
            if (oldValue !== '--' && oldValue !== value) {
                this.showChangeIndicator(metricId, oldValue, value);
            }
        }
    }
    
    // Icon definitions using Grove icon system
    getRowsIcon() {
        return `
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
            </svg>
        `;
    }
    
    getColumnsIcon() {
        return `
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
        `;
    }
    
    // Additional helper methods for calculations...
    formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toLocaleString();
    }
}
```

### 2. Grove KPI Styling
```css
/* NEW: data-studio-base.css - Grove metrics styling */
.grove-metrics-grid {
    margin: var(--grove-spacing-lg) 0;
    padding: var(--grove-spacing-md);
    background: var(--grove-bg-surface);
    border-radius: var(--grove-border-radius-lg);
    border: 1px solid var(--grove-border-color);
}

.grove-metrics-title {
    font-size: var(--grove-text-sm);
    font-weight: var(--grove-font-semibold);
    color: var(--grove-text-primary);
    margin-bottom: var(--grove-spacing-md);
    text-align: center;
}

.grove-kpi-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--grove-spacing-sm);
}

.grove-kpi-card {
    background: var(--grove-bg-primary);
    border: 1px solid var(--grove-border-color);
    border-radius: var(--grove-border-radius-md);
    padding: var(--grove-spacing-sm);
    text-align: center;
    transition: all 0.2s ease;
    cursor: default;
}

.grove-kpi-card:hover {
    border-color: var(--grove-border-hover);
    box-shadow: var(--grove-shadow-sm);
}

/* Color variants for KPI cards */
.grove-kpi-card--blue:hover { border-color: var(--grove-blue-300); }
.grove-kpi-card--purple:hover { border-color: var(--grove-purple-300); }
.grove-kpi-card--red:hover { border-color: var(--grove-red-300); }
.grove-kpi-card--green:hover { border-color: var(--grove-green-300); }
.grove-kpi-card--indigo:hover { border-color: var(--grove-indigo-300); }
.grove-kpi-card--orange:hover { border-color: var(--grove-orange-300); }

.grove-kpi-icon-container {
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--grove-spacing-xs);
}

/* Icon color variants */
.grove-kpi-icon--blue {
    background: var(--grove-blue-100);
    color: var(--grove-blue-600);
}
.grove-kpi-icon--purple {
    background: var(--grove-purple-100);
    color: var(--grove-purple-600);
}
.grove-kpi-icon--red {
    background: var(--grove-red-100);
    color: var(--grove-red-600);
}
.grove-kpi-icon--green {
    background: var(--grove-green-100);
    color: var(--grove-green-600);
}
.grove-kpi-icon--indigo {
    background: var(--grove-indigo-100);
    color: var(--grove-indigo-600);
}
.grove-kpi-icon--orange {
    background: var(--grove-orange-100);
    color: var(--grove-orange-600);
}

.grove-kpi-label {
    font-size: var(--grove-text-xs);
    font-weight: var(--grove-font-medium);
    color: var(--grove-text-secondary);
    margin-bottom: var(--grove-spacing-xs);
}

.grove-kpi-value {
    font-size: var(--grove-text-sm);
    font-weight: var(--grove-font-bold);
    color: var(--grove-text-primary);
    line-height: 1.2;
}

.grove-kpi-change {
    font-size: var(--grove-text-xs);
    margin-top: var(--grove-spacing-xs);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--grove-spacing-xs);
}

.grove-kpi-change-indicator {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
}

.grove-kpi-change--positive .grove-kpi-change-indicator {
    background: var(--grove-green-500);
}

.grove-kpi-change--negative .grove-kpi-change-indicator {
    background: var(--grove-red-500);
}

/* Responsive grid */
@media (max-width: 480px) {
    .grove-kpi-grid {
        grid-template-columns: 1fr;
        gap: var(--grove-spacing-xs);
    }
    
    .grove-kpi-card {
        padding: var(--grove-spacing-xs);
    }
}
```

### 3. Integration with Existing System
Update `data_tools/static/data_tools/js/data_studio_sidebar.js`:

```javascript
// Enhanced updateStats method
updateStats() {
    // Legacy support
    if (this.gridManager && this.gridManager.gridApi) {
        const api = this.gridManager.gridApi;
        const rowCount = api.getDisplayedRowCount();
        const columnCount = api.getColumnDefs()?.length || 0;
        
        // Update legacy elements
        const rowElement = document.getElementById('sidebar-row-count');
        const columnElement = document.getElementById('sidebar-column-count');
        
        if (rowElement) rowElement.textContent = rowCount.toLocaleString();
        if (columnElement) columnElement.textContent = columnCount.toLocaleString();
        
        // Update Grove metrics if available
        if (window.dataStudioMetrics) {
            window.dataStudioMetrics.updateMetrics();
        }
    }
}

// Initialize metrics system
init() {
    // ... existing initialization ...
    
    // Initialize Grove metrics
    if (this.gridManager) {
        window.dataStudioMetrics = new DataStudioMetrics(this.gridManager);
    }
}
```

## Implementation Steps

### Step 1: Create Metrics Class
Add to `data_tools/static/data_tools/js/data_studio.js`:

```javascript
// Append DataStudioMetrics class (implementation above)
```

### Step 2: Add Grove Styling
Create/update `data_tools/static/data_tools/css/data-studio-base.css`:

```css
/* Add Grove KPI styling (implementation above) */
```

### Step 3: Update Sidebar Integration
Modify `data_tools/static/data_tools/js/data_studio_sidebar.js` to include Grove metrics initialization.

### Step 4: Template Integration
Update `data_tools/templates/data_tools/data_studio.html`:

```html
{% block extra_css %}
<link rel="stylesheet" href="{% static 'data_tools/css/data-studio-base.css' %}">
{% endblock %}
```

## Files Modified

### Primary Files
1. **data_tools/static/data_tools/js/data_studio.js**
   - Add DataStudioMetrics class
   - Implement Grove KPI card system
   - Add metrics calculation methods

2. **data_tools/static/data_tools/css/data-studio-base.css**
   - Grove KPI styling system
   - Color variants and hover states
   - Responsive grid layout

3. **data_tools/static/data_tools/js/data_studio_sidebar.js**
   - Enhanced updateStats method
   - Grove metrics initialization
   - Legacy compatibility

## Testing Requirements

### Visual Testing
- [ ] KPI cards match Grove design patterns
- [ ] Icons display correctly with proper colors
- [ ] Responsive layout works on mobile
- [ ] Hover states and transitions smooth

### Data Accuracy
- [ ] Row counts match actual data
- [ ] Column counts accurate
- [ ] Missing data calculations correct
- [ ] Memory usage estimates reasonable

### Integration Testing
- [ ] Works with existing data loading
- [ ] Updates when data changes
- [ ] No conflicts with current functionality
- [ ] Performance impact minimal

## Acceptance Criteria
- [ ] Rich visual KPI cards replace basic text
- [ ] Grove design system fully integrated
- [ ] All metrics accurate and real-time
- [ ] Responsive across all devices
- [ ] Smooth animations and transitions
- [ ] Backward compatibility maintained

## Performance Considerations
- Efficient metric calculations
- Debounced updates during rapid changes
- Minimal DOM manipulation
- CSS transitions over JavaScript animations

## Dependencies
- Issue 2: Sidebar Margins Evaluation (affects metrics positioning)
- Grove design tokens and color system
- Existing grid manager and data structures

## Related Issues
- Issue 2: Sidebar Margins Evaluation (metrics placement)
- Issue 6: CSS Architecture Modernization (shares styling system)