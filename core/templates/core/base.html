{% load static %}
<!DOCTYPE html>
<html lang="es" class="h-full" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HydroML{% endblock %}</title>
    
    <!-- Prevent flash of unstyled content (FOUC) in dark mode -->
    <script>
      // Prevents flash of unstyled content (FOUC) in dark mode
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
    
    <!-- Inter Font for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.dataTables.css" />
    
    <!-- AG Grid CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.1.1/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.1.1/styles/ag-theme-quartz.css">
    
    {% block extra_css %}{% endblock %}
    
    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="{% static 'js/app.js' %}"></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body class="h-full bg-background-primary dark:bg-onedark-background font-sans antialiased" x-data="hydroMLApp">
    
    <!-- Upload Data Slide-Over Panel -->
    <div x-show="isUploadPanelOpen" 
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @close-upload-panel.window="isUploadPanelOpen = false"
         class="fixed inset-0 z-50"
         x-cloak>
        
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-600 bg-opacity-75" 
             @click="isUploadPanelOpen = false"></div>
        
        <!-- Panel -->
        <div class="fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16"
             x-show="isUploadPanelOpen"
             x-transition:enter="transform transition ease-in-out duration-500"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transform transition ease-in-out duration-500"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full">
            
            <div class="w-screen max-w-2xl">
                <div class="flex h-full flex-col bg-background-primary dark:bg-darcula-background-darker shadow-xl border-l border-border-default dark:border-darcula-border-light">
                    
                    <!-- Header -->
                    <div class="flex min-h-0 flex-1 flex-col">
                        <div class="bg-background-secondary dark:bg-darcula-background border-b border-border-default dark:border-darcula-border-light px-4 py-6 sm:px-6">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold text-foreground-default dark:text-darcula-foreground">
                                    Subir Nueva Fuente de Datos
                                </h2>
                                <div class="ml-3 flex h-7 items-center">
                                    <button type="button" 
                                            @click="isUploadPanelOpen = false"
                                            class="rounded-md bg-transparent text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground focus:outline-none focus:ring-2 focus:ring-darcula-accent">
                                        <span class="sr-only">Cerrar panel</span>
                                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="relative flex-1 px-4 py-6 sm:px-6 overflow-y-auto">
                            <div id="upload-form-container" class="space-y-6">
                                <!-- Form will be loaded here dynamically -->
                                <div class="flex items-center justify-center h-32">
                                    <div class="text-center">
                                        <svg class="mx-auto h-8 w-8 text-foreground-muted dark:text-darcula-foreground-muted animate-spin" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <p class="mt-2 text-sm text-foreground-muted dark:text-darcula-foreground-muted">Cargando formulario...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Experiment Slide-Over Panel -->
    <div x-show="isNewExperimentPanelOpen" 
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @close-new-experiment-panel.window="isNewExperimentPanelOpen = false"
         class="fixed inset-0 z-50"
         x-cloak>
        
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-600 bg-opacity-75" 
             @click="isNewExperimentPanelOpen = false"></div>
        
        <!-- Panel -->
        <div class="fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16"
             x-show="isNewExperimentPanelOpen"
             x-transition:enter="transform transition ease-in-out duration-500"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transform transition ease-in-out duration-500"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full">
            
            <div class="w-screen max-w-4xl">
                <div class="flex h-full flex-col bg-background-primary dark:bg-darcula-background-darker shadow-xl border-l border-border-default dark:border-darcula-border-light">
                    
                    <!-- Header -->
                    <div class="flex min-h-0 flex-1 flex-col">
                        <div class="bg-background-secondary dark:bg-darcula-background border-b border-border-default dark:border-darcula-border-light px-4 py-6 sm:px-6">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold text-foreground-default dark:text-darcula-foreground">
                                    Crear Nuevo Experimento ML
                                </h2>
                                <div class="ml-3 flex h-7 items-center">
                                    <button type="button" 
                                            @click="isNewExperimentPanelOpen = false"
                                            class="rounded-md bg-transparent text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground focus:outline-none focus:ring-2 focus:ring-darcula-accent">
                                        <span class="sr-only">Cerrar panel</span>
                                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="relative flex-1 px-4 py-6 sm:px-6 overflow-y-auto">
                            <div id="new-experiment-form-container" class="space-y-6">
                                <!-- Form will be loaded here dynamically -->
                                <div class="flex items-center justify-center h-32">
                                    <div class="text-center">
                                        <svg class="mx-auto h-8 w-8 text-foreground-muted dark:text-darcula-foreground-muted animate-spin" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <p class="mt-2 text-sm text-foreground-muted dark:text-darcula-foreground-muted">Cargando formulario...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Layout Container -->
    <div class="flex h-full">
        
        <!-- Mobile Sidebar Overlay -->
        <div x-show="sidebarOpen" 
             x-transition:enter="transition-opacity ease-linear duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-linear duration-300"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 z-40 lg:hidden"
             x-cloak>
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75" @click="sidebarOpen = false"></div>
        </div>

        <!-- Sidebar -->
        <aside @mouseenter="expandSidebar()" 
               @mouseleave="collapseSidebar()"
               class="fixed inset-y-0 left-0 z-50 bg-background-primary dark:bg-darcula-background border-r border-border-default dark:border-darcula-border transform transition-all duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0"
               :class="{ 
                   '-translate-x-full': !sidebarOpen && window.innerWidth < 1024, 
                   'translate-x-0': sidebarOpen || window.innerWidth >= 1024,
                   'w-16': !sidebarExpanded && !sidebarPinned,
                   'w-64': sidebarExpanded || sidebarPinned
               }"
               x-cloak>
            
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between h-16 px-4 border-b border-border-muted dark:border-darcula-border">
                <a href="{% url 'home' %}" class="flex items-center space-x-3 min-w-0">
                    <div class="w-8 h-8 bg-brand-500 dark:bg-darcula-accent rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-white dark:text-darcula-background font-bold text-lg">💧</span>
                    </div>
                    <span x-show="sidebarExpanded || sidebarPinned" 
                          x-transition:enter="transition-opacity ease-in duration-200"
                          x-transition:enter-start="opacity-0"
                          x-transition:enter-end="opacity-100"
                          x-transition:leave="transition-opacity ease-out duration-150"
                          x-transition:leave-start="opacity-100"
                          x-transition:leave-end="opacity-0"
                          class="font-semibold text-lg text-foreground-default dark:text-darcula-foreground truncate">HydroML</span>
                </a>
                
                <!-- Pin button (only visible when expanded) -->
                <button x-show="sidebarExpanded || sidebarPinned"
                        x-transition:enter="transition-opacity ease-in duration-200"
                        x-transition:enter-start="opacity-0"
                        x-transition:enter-end="opacity-100"
                        x-transition:leave="transition-opacity ease-out duration-150"
                        x-transition:leave-start="opacity-100"
                        x-transition:leave-end="opacity-0"
                        @click="togglePin()" 
                        class="p-1.5 rounded-md text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter transition-colors"
                        :class="{ 'text-brand-600 dark:text-darcula-accent': sidebarPinned }"
                        title="Pin sidebar">
                    <!-- Pin icon -->
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                </button>
                
                <!-- Mobile close button -->
                <button @click="sidebarOpen = false" 
                        class="lg:hidden rounded-md p-2 text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="flex-1 px-2 py-6 space-y-2 overflow-y-auto">
                {% block sidebar %}
                    {% include 'core/_sidebar.html' %}
                {% endblock %}
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-border-muted dark:border-darcula-border">
                {% if user.is_authenticated %}
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-8 h-8 bg-brand-100 dark:bg-darcula-accent/20 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-brand-600 dark:text-darcula-accent font-semibold text-sm">{{ user.username|first|upper }}</span>
                        </div>
                        <div x-show="sidebarExpanded || sidebarPinned" 
                             x-transition:enter="transition-opacity ease-in duration-200"
                             x-transition:enter-start="opacity-0"
                             x-transition:enter-end="opacity-100"
                             x-transition:leave="transition-opacity ease-out duration-150"
                             x-transition:leave-start="opacity-100"
                             x-transition:leave-end="opacity-0"
                             class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-foreground-default dark:text-darcula-foreground truncate">{{ user.username }}</p>
                            <p class="text-xs text-foreground-muted dark:text-darcula-foreground-muted truncate">{{ user.email|default:"Usuario" }}</p>
                        </div>
                    </div>
                    <a href="{% url 'logout' %}" 
                       class="flex items-center w-full px-3 py-2 text-sm font-medium text-foreground-secondary dark:text-darcula-foreground-muted hover:text-danger-600 dark:hover:text-darcula-error hover:bg-danger-50 dark:hover:bg-darcula-error/10 rounded-lg transition-colors"
                       :class="{ 'justify-center': !sidebarExpanded && !sidebarPinned }"
                       :title="!sidebarExpanded && !sidebarPinned ? 'Cerrar Sesión' : ''">
                        <svg class="w-5 h-5" :class="{ 'mr-3': sidebarExpanded || sidebarPinned }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span x-show="sidebarExpanded || sidebarPinned"
                              x-transition:enter="transition-opacity ease-in duration-200"
                              x-transition:enter-start="opacity-0"
                              x-transition:enter-end="opacity-100"
                              x-transition:leave="transition-opacity ease-out duration-150"
                              x-transition:leave-start="opacity-100"
                              x-transition:leave-end="opacity-0">Cerrar Sesión</span>
                    </a>
                {% else %}
                    <div class="space-y-2">
                        <a href="{% url 'login' %}" 
                           class="flex items-center w-full px-3 py-2 text-sm font-medium text-foreground-default dark:text-darcula-foreground hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter rounded-lg transition-colors"
                           :class="{ 'justify-center': !sidebarExpanded && !sidebarPinned }"
                           :title="!sidebarExpanded && !sidebarPinned ? 'Iniciar Sesión' : ''">
                            <svg class="w-5 h-5" :class="{ 'mr-3': sidebarExpanded || sidebarPinned }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                            </svg>
                            <span x-show="sidebarExpanded || sidebarPinned"
                                  x-transition:enter="transition-opacity ease-in duration-200"
                                  x-transition:enter-start="opacity-0"
                                  x-transition:enter-end="opacity-100"
                                  x-transition:leave="transition-opacity ease-out duration-150"
                                  x-transition:leave-start="opacity-100"
                                  x-transition:leave-end="opacity-0">Iniciar Sesión</span>
                        </a>
                        <a href="{% url 'signup' %}" 
                           class="flex items-center w-full px-3 py-2 text-sm font-medium text-white bg-gray-800 dark:bg-gray-700 hover:bg-gray-900 dark:hover:bg-gray-600 rounded-lg transition-colors"
                           :class="{ 'justify-center': !sidebarExpanded && !sidebarPinned }"
                           :title="!sidebarExpanded && !sidebarPinned ? 'Registrarse' : ''">
                            <svg class="w-5 h-5" :class="{ 'mr-3': sidebarExpanded || sidebarPinned }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                            </svg>
                            <span x-show="sidebarExpanded || sidebarPinned"
                                  x-transition:enter="transition-opacity ease-in duration-200"
                                  x-transition:enter-start="opacity-0"
                                  x-transition:enter-end="opacity-100"
                                  x-transition:leave="transition-opacity ease-out duration-150"
                                  x-transition:leave-start="opacity-100"
                                  x-transition:leave-end="opacity-0">Registrarse</span>
                        </a>
                    </div>
                {% endif %}
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col min-w-0 transition-all duration-300 ease-in-out"
             :class="{ 
                 'lg:ml-16': !sidebarExpanded && !sidebarPinned,
                 'lg:ml-64': sidebarExpanded || sidebarPinned
             }">
            
            <!-- Header -->
            <header class="bg-background-primary dark:bg-onedark-background border-b border-border-default dark:border-onedark-border h-16 flex items-center justify-between px-6 lg:px-8">
                
                <!-- Mobile menu button -->
                <button @click="sidebarOpen = true" 
                        class="lg:hidden rounded-md p-2 text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>

                <!-- Header content -->
                <div class="flex-1 flex items-center justify-between">
                    <!-- Breadcrumbs or page title -->
                    <div class="flex items-center space-x-4">
                        {% block header_title %}
                            <h1 class="text-lg font-semibold text-foreground-default dark:text-darcula-foreground">{% block page_title %}Dashboard{% endblock %}</h1>
                            
                            <!-- Breadcrumbs -->
                            {% block breadcrumbs %}
                                {% if breadcrumbs %}
                                    <nav class="flex items-center space-x-2 text-sm" aria-label="Breadcrumb">
                                        <ol class="flex items-center space-x-2">
                                            {% for breadcrumb in breadcrumbs %}
                                                <li class="flex items-center">
                                                    {% if not forloop.first %}
                                                        <svg class="w-4 h-4 mx-2 text-foreground-muted dark:text-darcula-foreground-muted" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                                        </svg>
                                                    {% endif %}
                                                    
                                                    {% if forloop.last %}
                                                        <!-- Current page (no link) -->
                                                        <span class="text-foreground-default dark:text-darcula-foreground font-medium">{{ breadcrumb.name }}</span>
                                                    {% else %}
                                                        <!-- Link to previous pages -->
                                                        <a href="{{ breadcrumb.url }}" 
                                                           class="text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground transition-colors">
                                                            {{ breadcrumb.name }}
                                                        </a>
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                        </ol>
                                    </nav>
                                {% endif %}
                            {% endblock %}
                        {% endblock %}
                    </div>

                    <!-- Header actions -->
                    <div class="flex items-center space-x-2 md:space-x-4">
                        {% block header_actions %}
                            <!-- Header action buttons will go here -->
                        {% endblock %}
                        
                        <!-- Theme Toggle Button -->
                        <button @click="toggleTheme()" 
                                class="p-2 text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter rounded-lg transition-colors flex-shrink-0"
                                title="Toggle theme">
                            <!-- Sun icon for light mode -->
                            <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            <!-- Moon icon for dark mode -->
                            <svg x-show="darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>
                        
                        <!-- User Controls Section -->
                        {% if user.is_authenticated %}
                            <div class="hidden md:flex items-center space-x-3">
                                <!-- Notifications Button -->
                                <div class="relative" x-data="notificationDropdown()" x-init="init()">
                                    <button @click="toggleDropdown()" 
                                            type="button" 
                                            class="relative p-2 text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter rounded-lg transition-colors"
                                            title="Notificaciones">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-3.5-3.5a50 50 0 01-7.5 0L6 17h5m4 0v1a3 3 0 01-6 0v-1m6 0a3 3 0 01-6 0"></path>
                                        </svg>
                                        <!-- Notification dot -->
                                        <span x-show="unreadCount > 0" 
                                              x-text="unreadCount > 99 ? '99+' : unreadCount"
                                              class="absolute -top-1 -right-1 min-w-[1.25rem] h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center px-1">
                                        </span>
                                    </button>

                                    <!-- Notifications Dropdown -->
                                    <div x-show="isOpen" 
                                         @click.away="closeDropdown()"
                                         x-transition:enter="transition ease-out duration-100"
                                         x-transition:enter-start="transform opacity-0 scale-95"
                                         x-transition:enter-end="transform opacity-100 scale-100"
                                         x-transition:leave="transition ease-in duration-75"
                                         x-transition:leave-start="transform opacity-100 scale-100"
                                         x-transition:leave-end="transform opacity-0 scale-95"
                                         class="absolute right-0 mt-2 w-80 bg-background-primary dark:bg-darcula-background-darker border border-border-default dark:border-darcula-border rounded-lg shadow-lg z-50 max-h-96 overflow-hidden">
                                        
                                        <!-- Header -->
                                        <div class="px-4 py-3 border-b border-border-default dark:border-darcula-border">
                                            <div class="flex items-center justify-between">
                                                <h3 class="text-sm font-semibold text-foreground-default dark:text-darcula-foreground">
                                                    Notificaciones
                                                </h3>
                                                <button @click="markAllAsRead()" 
                                                        x-show="notifications.length > 0"
                                                        class="text-xs text-brand-600 dark:text-darcula-accent hover:text-brand-700 dark:hover:text-darcula-accent/80 transition-colors">
                                                    Marcar todas como leídas
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Notifications List -->
                                        <div class="max-h-80 overflow-y-auto">
                                            <template x-if="loading">
                                                <div class="flex items-center justify-center py-8">
                                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-brand-600 dark:border-darcula-accent"></div>
                                                </div>
                                            </template>

                                            <template x-if="!loading && notifications.length === 0">
                                                <div class="px-4 py-8 text-center text-foreground-muted dark:text-darcula-foreground-muted">
                                                    <svg class="w-12 h-12 mx-auto mb-3 text-foreground-muted dark:text-darcula-foreground-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-3.5-3.5a50 50 0 01-7.5 0L6 17h5m4 0v1a3 3 0 01-6 0v-1m6 0a3 3 0 01-6 0"></path>
                                                    </svg>
                                                    <p class="text-sm">No tienes notificaciones</p>
                                                </div>
                                            </template>

                                            <template x-for="notification in notifications" :key="notification.id">
                                                <div @click="handleNotificationClick(notification)" 
                                                     class="px-4 py-3 border-b border-border-muted dark:border-darcula-border-light hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter cursor-pointer transition-colors">
                                                    <div class="flex items-start space-x-3">
                                                        <!-- Notification Icon -->
                                                        <div class="flex-shrink-0 mt-1">
                                                            <template x-if="notification.notification_type === 'experiment'">
                                                                <div class="w-8 h-8 bg-blue-100 dark:bg-darcula-accent/20 rounded-full flex items-center justify-center">
                                                                    <svg class="w-4 h-4 text-blue-600 dark:text-darcula-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                                    </svg>
                                                                </div>
                                                            </template>
                                                        </div>
                                                        
                                                        <!-- Notification Content -->
                                                        <div class="flex-1 min-w-0">
                                                            <p class="text-sm text-foreground-default dark:text-darcula-foreground" x-text="notification.message"></p>
                                                            <p class="text-xs text-foreground-muted dark:text-darcula-foreground-muted mt-1" x-text="notification.time_ago"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- User Profile Dropdown -->
                                <div class="relative" x-data="{ open: false }">
                                    <button @click="open = !open" 
                                            type="button" 
                                            class="flex items-center space-x-2 p-2 text-foreground-muted dark:text-darcula-foreground-muted hover:text-foreground-default dark:hover:text-darcula-foreground hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter rounded-lg transition-colors"
                                            aria-expanded="false">
                                        <div class="w-8 h-8 bg-brand-100 dark:bg-darcula-accent/20 rounded-full flex items-center justify-center">
                                            <span class="text-brand-600 dark:text-darcula-accent font-semibold text-sm">{{ user.username|first|upper }}</span>
                                        </div>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>

                                    <!-- Dropdown Menu -->
                                    <div x-show="open" 
                                         @click.away="open = false"
                                         x-transition:enter="transition ease-out duration-100"
                                         x-transition:enter-start="transform opacity-0 scale-95"
                                         x-transition:enter-end="transform opacity-100 scale-100"
                                         x-transition:leave="transition ease-in duration-75"
                                         x-transition:leave-start="transform opacity-100 scale-100"
                                         x-transition:leave-end="transform opacity-0 scale-95"
                                         class="absolute right-0 mt-2 w-48 origin-top-right bg-background-primary dark:bg-darcula-background-darker border border-border-default dark:border-darcula-border rounded-lg shadow-lg z-50"
                                         x-cloak>
                                        <div class="py-1">
                                            <!-- User Info -->
                                            <div class="px-4 py-3 border-b border-border-muted dark:border-darcula-border">
                                                <p class="text-sm font-medium text-foreground-default dark:text-darcula-foreground">{{ user.username }}</p>
                                                <p class="text-xs text-foreground-muted dark:text-darcula-foreground-muted">{{ user.email|default:"Usuario" }}</p>
                                            </div>
                                            
                                            <!-- Menu Items -->
                                            <a href="{% url 'accounts:settings' %}" 
                                               class="flex items-center px-4 py-2 text-sm text-foreground-default dark:text-darcula-foreground hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter transition-colors">
                                                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                </svg>
                                                Configuración
                                            </a>
                                            
                                            <div class="border-t border-border-muted dark:border-darcula-border"></div>
                                            
                                            <a href="{% url 'logout' %}" 
                                               class="flex items-center px-4 py-2 text-sm text-danger-600 dark:text-darcula-error hover:bg-danger-50 dark:hover:bg-darcula-error/10 transition-colors">
                                                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                                </svg>
                                                Cerrar Sesión
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Mobile User Menu -->
                        {% if user.is_authenticated %}
                            <div class="md:hidden">
                                <div class="w-8 h-8 bg-brand-100 dark:bg-darcula-accent/20 rounded-full flex items-center justify-center">
                                    <span class="text-brand-600 dark:text-darcula-accent font-semibold text-sm">{{ user.username|first|upper }}</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto bg-background-primary dark:bg-onedark-background text-foreground-default dark:text-onedark-foreground text-sm">
                <div class="p-6 lg:p-8">
                    <!-- Django Messages -->
                    {% if messages %}
                        <div class="mb-6 space-y-3">
                            {% for message in messages %}
                                <div class="flex items-center p-4 rounded-lg border {% if message.tags == 'success' %}bg-success-50 dark:bg-darcula-string/10 border-success-200 dark:border-darcula-string/30 text-success-700 dark:text-darcula-string{% elif message.tags == 'error' %}bg-danger-50 dark:bg-darcula-error/10 border-danger-200 dark:border-darcula-error/30 text-danger-700 dark:text-darcula-error{% elif message.tags == 'warning' %}bg-warning-50 dark:bg-darcula-keyword/10 border-warning-200 dark:border-darcula-keyword/30 text-warning-700 dark:text-darcula-keyword{% else %}bg-blue-50 dark:bg-darcula-accent/10 border-blue-200 dark:border-darcula-accent/30 text-blue-700 dark:text-darcula-accent{% endif %} animate-slide-up">
                                    <div class="flex-shrink-0 mr-3">
                                        {% if message.tags == 'success' %}
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        {% elif message.tags == 'error' %}
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        {% elif message.tags == 'warning' %}
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                            </svg>
                                        {% else %}
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1">
                                        {{ message }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Page Content -->
                    {% block content %}
                    {% endblock %}
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.js"></script>
    
    <!-- AG Grid JS -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.1.1/dist/ag-grid-community.min.js"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>