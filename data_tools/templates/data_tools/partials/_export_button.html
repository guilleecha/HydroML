<!-- Export Button - Pines UI Component for Data Studio Integration -->
<!-- Simple, clean button that integrates with existing Data Studio layout -->
<div x-data="exportButtonComponent()" class="export-button-wrapper">
    <!-- Main Export Button -->
    <button 
        @click="openExportModal()" 
        class="w-full flex items-center justify-center px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md text-sm font-medium transition-colors space-x-2 group"
        :disabled="isExporting"
        title="Export current dataset">
        <svg class="w-4 h-4 transition-transform group-hover:scale-105" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
        </svg>
        <span x-show="!isExporting">Export Data</span>
        <span x-show="isExporting" class="flex items-center space-x-1">
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Exporting...</span>
        </span>
    </button>

    <!-- Quick Export Actions (collapsed by default) -->
    <div x-show="showQuickActions" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-y-0"
         x-transition:enter-end="opacity-100 scale-y-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 scale-y-100"
         x-transition:leave-end="opacity-0 scale-y-0"
         class="mt-2 origin-top">
        <div class="grid grid-cols-3 gap-1 text-xs">
            <button 
                @click="quickExport('csv')" 
                class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors"
                :disabled="isExporting">
                CSV
            </button>
            <button 
                @click="quickExport('json')" 
                class="px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded transition-colors"
                :disabled="isExporting">
                JSON
            </button>
            <button 
                @click="quickExport('excel')" 
                class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded transition-colors"
                :disabled="isExporting">
                Excel
            </button>
        </div>
    </div>

    <!-- Toggle Quick Actions -->
    <button 
        @click="showQuickActions = !showQuickActions"
        class="w-full mt-1 flex items-center justify-center px-2 py-1 text-xs text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
        <svg class="w-3 h-3 transform transition-transform" 
             :class="{'rotate-180': showQuickActions}" 
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
        <span class="ml-1">Quick Export</span>
    </button>
</div>

<script>
function exportButtonComponent() {
    return {
        isExporting: false,
        showQuickActions: false,

        openExportModal() {
            // Trigger the main export modal
            if (window.exportWizard) {
                window.exportWizard.open();
            } else {
                console.warn('Export wizard not initialized');
            }
        },

        async quickExport(format) {
            this.isExporting = true;
            try {
                // Use the current grid data and filters
                const gridApi = window.gridApi;
                if (!gridApi) {
                    throw new Error('Grid not available');
                }

                // Get current data and filters
                const data = {
                    datasource_id: window.datasourceId,
                    format: format,
                    filters: this.getCurrentFilters(),
                    options: {
                        include_filtered_only: true,
                        quick_export: true
                    }
                };

                const response = await this.createExportJob(data);
                if (response.success) {
                    // Start monitoring the export job
                    this.monitorExportJob(response.data.id);
                    
                    // Show success message
                    this.showAlert('Export started successfully', 'success');
                } else {
                    throw new Error(response.message || 'Export failed');
                }
            } catch (error) {
                console.error('Quick export failed:', error);
                this.showAlert(error.message || 'Export failed', 'error');
            } finally {
                this.isExporting = false;
            }
        },

        getCurrentFilters() {
            // Get current AG Grid filters
            const gridApi = window.gridApi;
            if (gridApi && typeof gridApi.getFilterModel === 'function') {
                return gridApi.getFilterModel();
            }
            return {};
        },

        async createExportJob(data) {
            const response = await fetch('/tools/api/v1/exports/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(data)
            });
            return await response.json();
        },

        async monitorExportJob(jobId) {
            const checkStatus = async () => {
                try {
                    const response = await fetch(`/tools/api/v1/exports/${jobId}/`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        const job = result.data;
                        
                        if (job.status === 'completed') {
                            // Auto-download the file
                            this.downloadFile(jobId);
                            this.showAlert('Export completed successfully!', 'success');
                        } else if (job.status === 'failed') {
                            this.showAlert(`Export failed: ${job.error_message}`, 'error');
                        } else if (job.status === 'processing' || job.status === 'pending') {
                            // Continue monitoring
                            setTimeout(checkStatus, 2000);
                        }
                    }
                } catch (error) {
                    console.error('Error monitoring export job:', error);
                }
            };
            
            setTimeout(checkStatus, 1000);
        },

        downloadFile(jobId) {
            // Trigger download
            const downloadUrl = `/tools/api/v1/exports/${jobId}/download/`;
            window.open(downloadUrl, '_blank');
        },

        showAlert(message, type) {
            // Show alert using existing notification system or create simple alert
            if (window.dataStudioNotifications) {
                window.dataStudioNotifications.show(message, type);
            } else {
                // Fallback to console for now
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        },

        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
        }
    };
}
</script>