{% extends "core/base.html" %}
{% load static %}
{% load dict_extras %}

{% block page_title %}Data Studio - {{ datasource.name }}{% endblock %}

{% block sidebar %}
<!-- Data Studio Contextual Sidebar -->
<ul class="space-y-1">
    <!-- Back to Project -->
    <li>
        <a href="{% url 'projects:project_detail' current_project.pk %}" 
           class="group flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors text-gray-500 dark:text-gray-400 hover:text-green-700 dark:hover:text-green-400 hover:bg-gray-50 dark:hover:bg-gray-800/50"
           :class="{ 'justify-center': !(sidebarExpanded || sidebarPinned) }"
           :title="!(sidebarExpanded || sidebarPinned) ? 'Back to Project' : ''">
            <svg class="flex-shrink-0 w-5 h-5 transition-colors text-gray-400 dark:text-gray-500 group-hover:text-green-600 dark:group-hover:text-green-400" 
                 :class="{ 'mr-3': sidebarExpanded || sidebarPinned }"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M15 19l-7-7 7-7"></path>
            </svg>
            <span x-show="sidebarExpanded || sidebarPinned"
                  x-transition:enter="transition-opacity ease-in duration-200"
                  x-transition:enter-start="opacity-0"
                  x-transition:enter-end="opacity-100"
                  x-transition:leave="transition-opacity ease-out duration-150"
                  x-transition:leave-start="opacity-100"
                  x-transition:leave-end="opacity-0">Back to Project</span>
        </a>
    </li>

    <!-- Separator -->
    <li class="border-t border-gray-200 dark:border-gray-700 my-2"></li>

    <!-- Data Overview -->
    <li x-show="sidebarExpanded || sidebarPinned">
        <div class="px-3 py-2">
            <p class="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Data Tools</p>
        </div>
    </li>

    <!-- Data Cleaning -->
    <li x-data="{ expanded: false }">
        <button @click="expanded = !expanded" 
                class="group flex items-center w-full px-3 py-2 text-sm font-medium rounded-lg transition-colors text-gray-600 dark:text-gray-400 hover:text-red-700 dark:hover:text-red-400 hover:bg-gray-50 dark:hover:bg-gray-800/50"
                :class="{ 'justify-center': !(sidebarExpanded || sidebarPinned) }"
                :title="!(sidebarExpanded || sidebarPinned) ? 'Missing Data' : ''">
            <svg class="flex-shrink-0 w-5 h-5 transition-colors text-gray-500" 
                 :class="{ 'mr-3': sidebarExpanded || sidebarPinned }"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <span x-show="sidebarExpanded || sidebarPinned" class="flex-1 text-left">Missing Data</span>
            <svg x-show="sidebarExpanded || sidebarPinned" :class="{ 'rotate-90': expanded }" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        <ul x-show="expanded && (sidebarExpanded || sidebarPinned)" 
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2"
            class="ml-8 mt-1 space-y-1">
            <li>
                <button @click="openOperationForm('handle-missing')" class="flex items-center w-full px-2 py-1 text-xs text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></span>
                    Fill Missing Values
                </button>
            </li>
            <li>
                <button @click="openOperationForm('remove-nulls')" class="flex items-center w-full px-2 py-1 text-xs text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></span>
                    Remove Nulls
                </button>
            </li>
        </ul>
    </li>

    <!-- Column Management -->
    <li x-data="{ expanded: false }">
        <button @click="expanded = !expanded" 
                class="group flex items-center w-full px-3 py-2 text-sm font-medium rounded-lg transition-colors text-gray-600 dark:text-gray-400 hover:text-blue-700 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800/50"
                :class="{ 'justify-center': !(sidebarExpanded || sidebarPinned) }"
                :title="!(sidebarExpanded || sidebarPinned) ? 'Column Management' : ''">
            <svg class="flex-shrink-0 w-5 h-5 transition-colors text-gray-500" 
                 :class="{ 'mr-3': sidebarExpanded || sidebarPinned }"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <span x-show="sidebarExpanded || sidebarPinned" class="flex-1 text-left">Columns</span>
            <svg x-show="sidebarExpanded || sidebarPinned" :class="{ 'rotate-90': expanded }" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        <ul x-show="expanded && (sidebarExpanded || sidebarPinned)" 
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2"
            class="ml-8 mt-1 space-y-1">
            <li>
                <button @click="openOperationForm('remove-columns')" class="flex items-center w-full px-2 py-1 text-xs text-gray-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></span>
                    Remove Columns
                </button>
            </li>
            <li>
                <button @click="openOperationForm('rename-columns')" class="flex items-center w-full px-2 py-1 text-xs text-gray-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></span>
                    Rename Columns
                </button>
            </li>
            <li>
                <button @click="openOperationForm('add-column')" class="flex items-center w-full px-2 py-1 text-xs text-gray-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></span>
                    Add Column
                </button>
            </li>
        </ul>
    </li>

    <!-- Data Types -->
    <li x-data="{ expanded: false }">
        <button @click="expanded = !expanded" 
                class="group flex items-center w-full px-3 py-2 text-sm font-medium rounded-lg transition-colors text-gray-600 dark:text-gray-400 hover:text-green-700 dark:hover:text-green-400 hover:bg-gray-50 dark:hover:bg-gray-800/50"
                :class="{ 'justify-center': !(sidebarExpanded || sidebarPinned) }"
                :title="!(sidebarExpanded || sidebarPinned) ? 'Data Types' : ''">
            <svg class="flex-shrink-0 w-5 h-5 transition-colors text-gray-500" 
                 :class="{ 'mr-3': sidebarExpanded || sidebarPinned }"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span x-show="sidebarExpanded || sidebarPinned" class="flex-1 text-left">Data Types</span>
            <svg x-show="sidebarExpanded || sidebarPinned" :class="{ 'rotate-90': expanded }" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        <ul x-show="expanded && (sidebarExpanded || sidebarPinned)" 
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2"
            class="ml-8 mt-1 space-y-1">
            <li>
                <button @click="openOperationForm('convert-numeric')" class="flex items-center w-full px-2 py-1 text-xs text-gray-500 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></span>
                    To Numeric
                </button>
            </li>
            <li>
                <button @click="openOperationForm('convert-categorical')" class="flex items-center w-full px-2 py-1 text-xs text-gray-500 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></span>
                    To Categorical
                </button>
            </li>
            <li>
                <button @click="openOperationForm('convert-datetime')" class="flex items-center w-full px-2 py-1 text-xs text-gray-500 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2"></span>
                    To DateTime
                </button>
            </li>
        </ul>
    </li>
</ul>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-quartz.css">

<style>
    /* Enhanced AG Grid theming with AG Grid best practices */
    .ag-theme-quartz .ag-header-cell,
    .ag-theme-quartz-dark .ag-header-cell {
        background: var(--ag-background-color);
        border-bottom: 1px solid var(--ag-border-color);
        padding: 8px 12px;
    }

    .ag-theme-quartz .ag-header-cell-text,
    .ag-theme-quartz-dark .ag-header-cell-text {
        font-weight: 600;
        font-size: 14px;
        color: var(--ag-header-foreground-color);
    }

    .ag-theme-quartz .ag-floating-filter-input,
    .ag-theme-quartz-dark .ag-floating-filter-input {
        background: var(--ag-background-color);
        border: 1px solid var(--ag-border-color);
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 13px;
    }

    .ag-theme-quartz .ag-floating-filter-input:focus,
    .ag-theme-quartz-dark .ag-floating-filter-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .ag-theme-quartz .ag-paging-panel,
    .ag-theme-quartz-dark .ag-paging-panel {
        background: var(--ag-background-color);
        border-top: 1px solid var(--ag-border-color);
        padding: 10px 16px;
    }

    .ag-theme-quartz .ag-paging-button,
    .ag-theme-quartz-dark .ag-paging-button {
        background: transparent;
        border: 1px solid var(--ag-border-color);
        border-radius: 4px;
        margin: 0 2px;
    }

    .ag-theme-quartz .ag-paging-button:hover,
    .ag-theme-quartz-dark .ag-paging-button:hover {
        background: var(--ag-row-hover-color);
        border-color: #3b82f6;
    }

    /* Data Studio Layout */
    .data-studio-container {
        display: flex;
        height: calc(100vh - 180px);
        background: rgb(var(--color-background-primary));
    }

    /* Left Panel - Operations */
    .left-operations-panel {
        width: 320px;
        background: rgb(var(--color-background-secondary));
        border-right: 1px solid rgb(var(--color-border-default));
        transition: width 0.3s ease;
        overflow-y: auto;
        flex-shrink: 0;
    }

    .left-operations-panel.collapsed {
        width: 60px;
    }

    /* Main Content Area */
    .main-content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgb(var(--color-background-primary));
    }

    /* Operation Categories */
    .operation-category {
        border-bottom: 1px solid rgb(var(--color-border-default));
    }

    .category-header {
        padding: 16px 20px;
        background: rgb(var(--color-background-secondary));
        border-bottom: 1px solid rgb(var(--color-border-default));
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .category-header:hover {
        background: rgb(var(--color-background-tertiary));
    }

    .category-content {
        background: rgb(var(--color-background-primary));
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .category-content.expanded {
        max-height: 800px;
    }

    /* Operation Items */
    .operation-item {
        padding: 12px 20px;
        border-bottom: 1px solid rgb(var(--color-border-light));
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .operation-item:hover {
        background: rgb(var(--color-background-tertiary));
        padding-left: 24px;
    }

    .operation-item:last-child {
        border-bottom: none;
    }

    /* Add Button */
    .add-operation-btn {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgb(var(--color-brand-600));
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0;
    }

    .operation-item:hover .add-operation-btn {
        opacity: 1;
        transform: scale(1.1);
    }

    .add-operation-btn:hover {
        background: rgb(var(--color-brand-700));
        transform: scale(1.2);
    }

    /* Form Panels */
    .operation-form-panel {
        position: fixed;
        right: -400px;
        top: 0;
        width: 400px;
        height: 100vh;
        background: rgb(var(--color-background-secondary));
        border-left: 1px solid rgb(var(--color-border-default));
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
    }

    .operation-form-panel.open {
        right: 0;
    }

    /* Dark theme optimizations */
    .dark .ag-theme-quartz-dark {
        --ag-background-color: rgb(var(--color-background-primary));
        --ag-foreground-color: rgb(var(--color-foreground-default));
        --ag-border-color: rgb(var(--color-border-default));
        --ag-header-background-color: rgb(var(--color-background-secondary));
        --ag-header-foreground-color: rgb(var(--color-foreground-default));
        --ag-row-hover-color: rgb(var(--color-background-tertiary));
        --ag-selected-row-background-color: rgb(var(--color-brand-100));
    }

    /* Collapse/Expand Button */
    .panel-toggle {
        position: absolute;
        top: 20px;
        right: -15px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgb(var(--color-brand-600));
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .panel-toggle:hover {
        background: rgb(var(--color-brand-700));
        transform: scale(1.1);
    }

    /* Minimalist Sliders */
    .custom-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: rgb(var(--color-background-tertiary));
        outline: none;
        transition: background 0.2s ease;
    }

    .custom-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgb(var(--color-brand-600));
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .custom-slider::-webkit-slider-thumb:hover {
        background: rgb(var(--color-brand-700));
        transform: scale(1.2);
    }

    .custom-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgb(var(--color-brand-600));
        cursor: pointer;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="dataStudioApp()" x-init="init()">
    <!-- Header Section -->
    <div class="bg-background-primary px-6 py-6 border-b border-border-default">        
        <!-- Header Title -->
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-background-secondary rounded-xl flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.78 0-2.678-2.153-1.415-3.414l5-5A2 2 0 009 11.172V5l-1-1z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-foreground-default">Data Studio</h1>
                    <p class="text-foreground-muted">{{ datasource.name }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modern KPI Dashboard -->
    {% if automated_analysis %}
    <!-- Session Controls Header -->
    <div class="px-6 py-4 bg-background-secondary border-b border-border-default">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-4">
                <h2 class="text-xl font-semibold text-foreground-default">Data Studio Session</h2>
                <div class="flex items-center space-x-2">
                    <span id="session-status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></span>
                    <span id="session-status-text" class="text-sm text-foreground-muted">No session</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <!-- Session Controls -->
                <button id="initialize-session-btn" 
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center space-x-2"
                        onclick="initializeSession()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>Start Session</span>
                </button>
                
                <button id="undo-btn" 
                        class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="undoOperation()" disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                    <span>Undo</span>
                </button>
                
                <button id="redo-btn" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="redoOperation()" disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"></path>
                    </svg>
                    <span>Redo</span>
                </button>
                
                <button id="save-session-btn" 
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="saveSession()" disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span>Save As New</span>
                </button>
                
                <button id="clear-session-btn" 
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="clearSession()" disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>Clear</span>
                </button>
            </div>
        </div>
        
        <!-- Session Info Display -->
        <div id="session-info" class="mb-4 p-3 bg-background-primary rounded-lg border border-border-default hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="font-medium text-foreground-default">History: </span>
                    <span id="history-info" class="text-foreground-muted">0 operations</span>
                </div>
                <div>
                    <span class="font-medium text-foreground-default">Position: </span>
                    <span id="position-info" class="text-foreground-muted">0/0</span>
                </div>
                <div>
                    <span class="font-medium text-foreground-default">Rows: </span>
                    <span id="rows-info" class="text-foreground-muted">0</span>
                </div>
                <div>
                    <span class="font-medium text-foreground-default">Columns: </span>
                    <span id="columns-info" class="text-foreground-muted">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="px-6 py-6 bg-background-secondary border-b border-border-subtle">
        <!-- Dataset Overview KPIs -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
            <!-- Total Rows -->
            <div class="bg-background-primary rounded-lg p-4 border border-border-default hover:border-border-accent transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-foreground-muted">Total Rows</p>
                        <p class="text-2xl font-bold text-foreground-default">{{ automated_analysis.basic_info.total_rows|floatformat:0 }}</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total Columns -->
            <div class="bg-background-primary rounded-lg p-4 border border-border-default hover:border-border-accent transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-foreground-muted">Columns</p>
                        <p class="text-2xl font-bold text-foreground-default">{{ automated_analysis.basic_info.total_columns }}</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Missing Values -->
            <div class="bg-background-primary rounded-lg p-4 border border-border-default hover:border-border-accent transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-foreground-muted">Missing Values</p>
                        <p class="text-2xl font-bold text-foreground-default">{{ automated_analysis.missing_data.total_missing_values|floatformat:0 }}</p>
                        <p class="text-xs text-foreground-muted">{{ automated_analysis.missing_data.missing_percentage|floatformat:1 }}%</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Data Types -->
            <div class="bg-background-primary rounded-lg p-4 border border-border-default hover:border-border-accent transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-foreground-muted">Data Types</p>
                        <div class="space-y-1">
                            <p class="text-sm text-foreground-default">Numeric: {{ automated_analysis.basic_info.numeric_columns }}</p>
                            <p class="text-sm text-foreground-default">Text: {{ automated_analysis.basic_info.categorical_columns }}</p>
                        </div>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Memory Usage -->
            <div class="bg-background-primary rounded-lg p-4 border border-border-default hover:border-border-accent transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-foreground-muted">Memory Usage</p>
                        <p class="text-2xl font-bold text-foreground-default">{{ automated_analysis.basic_info.memory_usage_mb|floatformat:1 }}</p>
                        <p class="text-xs text-foreground-muted">MB</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Duplicate Rows -->
            <div class="bg-background-primary rounded-lg p-4 border border-border-default hover:border-border-accent transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-foreground-muted">Duplicates</p>
                        <p class="text-2xl font-bold text-foreground-default">{{ automated_analysis.basic_info.duplicate_rows|default:0 }}</p>
                        <p class="text-xs text-foreground-muted">rows</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Data Grid Section -->
    <div class="px-6 py-6">
        <div class="bg-background-primary rounded-lg border border-border-default">
            <div class="p-4 border-b border-border-default">
                <h3 class="text-lg font-semibold text-foreground-default">Data Preview</h3>
                <p class="text-sm text-foreground-muted">{{ grid_data|length }} rows displayed</p>
            </div>
            <div class="p-4">
                <div id="data-preview-grid" 
                     class="h-full w-full ag-theme-quartz" 
                     style="height: 600px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Operation Form Panels (Right Side) -->
                <svg x-show="!panelCollapsed" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                <svg x-show="panelCollapsed" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            <div x-show="!panelCollapsed" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                <!-- Panel Header -->
                <div class="p-4 border-b border-border-default">
                    <h3 class="text-lg font-semibold text-foreground-default">Operaciones de Datos</h3>
                    <p class="text-sm text-foreground-muted">Selecciona una operación para comenzar</p>
                </div>

                <!-- Category 1: Datos Faltantes -->
                <div class="operation-category">
                    <div class="category-header" @click="toggleCategory('missing-data')">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <span class="font-medium text-foreground-default">Datos Faltantes</span>
                        </div>
                        <svg class="w-4 h-4 text-foreground-muted transition-transform duration-200" :class="{ 'rotate-180': expandedCategories.includes('missing-data') }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="category-content" :class="{ 'expanded': expandedCategories.includes('missing-data') }">
                        <div class="operation-item" @click="openOperationForm('mean-imputation')">
                            <div>
                                <div class="font-medium text-foreground-default">Imputación por Media</div>
                                <div class="text-sm text-foreground-muted">Reemplaza valores nulos con la media</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('median-imputation')">
                            <div>
                                <div class="font-medium text-foreground-default">Imputación por Mediana</div>
                                <div class="text-sm text-foreground-muted">Reemplaza valores nulos con la mediana</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('mode-imputation')">
                            <div>
                                <div class="font-medium text-foreground-default">Imputación por Moda</div>
                                <div class="text-sm text-foreground-muted">Reemplaza valores nulos con la moda</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('remove-nulls')">
                            <div>
                                <div class="font-medium text-foreground-default">Eliminar Filas con Nulos</div>
                                <div class="text-sm text-foreground-muted">Remueve filas que contengan valores nulos</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Category 2: Gestión de Columnas -->
                <div class="operation-category">
                    <div class="category-header" @click="toggleCategory('column-management')">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h2a2 2 0 002-2z"></path>
                            </svg>
                            <span class="font-medium text-foreground-default">Gestión de Columnas</span>
                        </div>
                        <svg class="w-4 h-4 text-foreground-muted transition-transform duration-200" :class="{ 'rotate-180': expandedCategories.includes('column-management') }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="category-content" :class="{ 'expanded': expandedCategories.includes('column-management') }">
                        <div class="operation-item" @click="openOperationForm('remove-columns')">
                            <div>
                                <div class="font-medium text-foreground-default">Eliminar Columnas</div>
                                <div class="text-sm text-foreground-muted">Selecciona columnas para eliminar</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('rename-columns')">
                            <div>
                                <div class="font-medium text-foreground-default">Renombrar Columnas</div>
                                <div class="text-sm text-foreground-muted">Cambia nombres de columnas</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('reorder-columns')">
                            <div>
                                <div class="font-medium text-foreground-default">Reordenar Columnas</div>
                                <div class="text-sm text-foreground-muted">Cambia el orden de las columnas</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Category 3: Feature Engineering -->
                <div class="operation-category">
                    <div class="category-header" @click="toggleCategory('feature-engineering')">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span class="font-medium text-foreground-default">Feature Engineering</span>
                        </div>
                        <svg class="w-4 h-4 text-foreground-muted transition-transform duration-200" :class="{ 'rotate-180': expandedCategories.includes('feature-engineering') }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="category-content" :class="{ 'expanded': expandedCategories.includes('feature-engineering') }">
                        <div class="operation-item" @click="openOperationForm('one-hot-encoding')">
                            <div>
                                <div class="font-medium text-foreground-default">One-Hot Encoding</div>
                                <div class="text-sm text-foreground-muted">Codifica variables categóricas</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('scaling')">
                            <div>
                                <div class="font-medium text-foreground-default">Escalado de Variables</div>
                                <div class="text-sm text-foreground-muted">Normaliza o estandariza columnas</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('binning')">
                            <div>
                                <div class="font-medium text-foreground-default">Discretización</div>
                                <div class="text-sm text-foreground-muted">Convierte variables continuas en categorías</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Category 4: Tipos de Datos -->
                <div class="operation-category">
                    <div class="category-header" @click="toggleCategory('data-types')">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span class="font-medium text-foreground-default">Tipos de Datos</span>
                        </div>
                        <svg class="w-4 h-4 text-foreground-muted transition-transform duration-200" :class="{ 'rotate-180': expandedCategories.includes('data-types') }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="category-content" :class="{ 'expanded': expandedCategories.includes('data-types') }">
                        <div class="operation-item" @click="openOperationForm('convert-numeric')">
                            <div>
                                <div class="font-medium text-foreground-default">Convertir a Numérico</div>
                                <div class="text-sm text-foreground-muted">Cambia columnas a tipo numérico</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('convert-categorical')">
                            <div>
                                <div class="font-medium text-foreground-default">Convertir a Categórico</div>
                                <div class="text-sm text-foreground-muted">Cambia columnas a tipo categórico</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="operation-item" @click="openOperationForm('convert-datetime')">
                            <div>
                                <div class="font-medium text-foreground-default">Convertir a Fecha/Hora</div>
                                <div class="text-sm text-foreground-muted">Convierte texto a formato fecha</div>
                            </div>
                            <button class="add-operation-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    <!-- Operation Form Panels (Right Side) -->
    <!-- Mean Imputation Form -->
    <div class="operation-form-panel" :class="{ 'open': activeForm === 'mean-imputation' }">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-foreground-default">Imputación por Media</h3>
                <button @click="closeForm()" class="text-foreground-muted hover:text-foreground-default">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form @submit.prevent="applyOperation('mean-imputation')">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-foreground-default mb-2">Columnas a imputar</label>
                        <select multiple class="w-full p-3 border border-border-default rounded-lg bg-background-primary text-foreground-default">
                            <option value="column1">Columna 1</option>
                            <option value="column2">Columna 2</option>
                            <option value="column3">Columna 3</option>
                        </select>
                        <p class="text-sm text-foreground-muted mt-1">Selecciona las columnas numéricas para imputar</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-foreground-default mb-2">Umbral de valores nulos (%)</label>
                        <input type="range" min="0" max="100" value="50" class="custom-slider" x-model="meanImputationThreshold">
                        <div class="flex justify-between text-sm text-foreground-muted mt-1">
                            <span>0%</span>
                            <span x-text="meanImputationThreshold + '%'"></span>
                            <span>100%</span>
                        </div>
                        <p class="text-sm text-foreground-muted mt-1">Solo imputar si menos del x% de valores son nulos</p>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                            Aplicar Imputación
                        </button>
                        <button type="button" @click="closeForm()" class="px-4 py-2 border border-border-default rounded-lg text-foreground-default hover:bg-background-secondary transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Scaling Form -->
    <div class="operation-form-panel" :class="{ 'open': activeForm === 'scaling' }">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-foreground-default">Escalado de Variables</h3>
                <button @click="closeForm()" class="text-foreground-muted hover:text-foreground-default">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form @submit.prevent="applyOperation('scaling')">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-foreground-default mb-2">Tipo de escalado</label>
                        <select class="w-full p-3 border border-border-default rounded-lg bg-background-primary text-foreground-default" x-model="scalingType">
                            <option value="standard">Estandarización (Z-score)</option>
                            <option value="minmax">Normalización (Min-Max)</option>
                            <option value="robust">Escalado Robusto</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-foreground-default mb-2">Columnas a escalar</label>
                        <select multiple class="w-full p-3 border border-border-default rounded-lg bg-background-primary text-foreground-default">
                            <option value="column1">Columna 1</option>
                            <option value="column2">Columna 2</option>
                            <option value="column3">Columna 3</option>
                        </select>
                    </div>
                    
                    <div x-show="scalingType === 'minmax'">
                        <label class="block text-sm font-medium text-foreground-default mb-2">Rango de escalado</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-foreground-muted mb-1">Mínimo</label>
                                <input type="number" value="0" step="0.1" class="w-full p-2 border border-border-default rounded-lg bg-background-primary text-foreground-default">
                            </div>
                            <div>
                                <label class="block text-xs text-foreground-muted mb-1">Máximo</label>
                                <input type="number" value="1" step="0.1" class="w-full p-2 border border-border-default rounded-lg bg-background-primary text-foreground-default">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                            Aplicar Escalado
                        </button>
                        <button type="button" @click="closeForm()" class="px-4 py-2 border border-border-default rounded-lg text-foreground-default hover:bg-background-secondary transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Binning Form -->
    <div class="operation-form-panel" :class="{ 'open': activeForm === 'binning' }">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-foreground-default">Discretización</h3>
                <button @click="closeForm()" class="text-foreground-muted hover:text-foreground-default">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form @submit.prevent="applyOperation('binning')">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-foreground-default mb-2">Columna a discretizar</label>
                        <select class="w-full p-3 border border-border-default rounded-lg bg-background-primary text-foreground-default">
                            <option value="column1">Columna 1</option>
                            <option value="column2">Columna 2</option>
                            <option value="column3">Columna 3</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-foreground-default mb-2">Número de bins</label>
                        <input type="range" min="2" max="20" value="5" class="custom-slider" x-model="numberOfBins">
                        <div class="flex justify-between text-sm text-foreground-muted mt-1">
                            <span>2</span>
                            <span x-text="numberOfBins"></span>
                            <span>20</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-foreground-default mb-2">Estrategia</label>
                        <select class="w-full p-3 border border-border-default rounded-lg bg-background-primary text-foreground-default">
                            <option value="uniform">Ancho uniforme</option>
                            <option value="quantile">Frecuencia uniforme</option>
                            <option value="kmeans">K-means</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                            Aplicar Discretización
                        </button>
                        <button type="button" @click="closeForm()" class="px-4 py-2 border border-border-default rounded-lg text-foreground-default hover:bg-background-secondary transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add more operation forms as needed -->
    <!-- ... (Other forms would follow similar pattern) ... -->

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<script>
// Make data available to JavaScript
window.gridRowData = {{ grid_data_json|safe }};
window.columnDefsData = {{ column_defs_json|safe }};
window.datasourceId = "{{ datasource.id }}";
window.datasourceName = "{{ datasource.name }}";
window.datasourceFilename = "{{ datasource.file.name }}";
window.datasourceFileType = "{{ datasource.source_type|default:'file' }}";

function dataStudioApp() {
    return {
        panelCollapsed: false,
        expandedCategories: [],
        activeForm: null,
        darkMode: document.documentElement.classList.contains('dark'),
        sessionActive: false,
        sessionInfo: null,
        
        // Form data
        meanImputationThreshold: 50,
        scalingType: 'standard',
        numberOfBins: 5,

        init() {
            this.initializeGrid();
            this.checkSessionStatus();
        },

        togglePanel() {
            this.panelCollapsed = !this.panelCollapsed;
        },

        toggleCategory(category) {
            const index = this.expandedCategories.indexOf(category);
            if (index > -1) {
                this.expandedCategories.splice(index, 1);
            } else {
                this.expandedCategories.push(category);
            }
        },

        openOperationForm(operationType) {
            this.activeForm = operationType;
        },

        closeForm() {
            this.activeForm = null;
        },

        async checkSessionStatus() {
            try {
                const response = await fetch(`/data_tools/api/studio/${window.datasourceId}/session/status/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    }
                });
                
                const data = await response.json();
                if (data.success && data.session_info.session_exists) {
                    this.updateSessionStatus(data.session_info);
                    this.updateDataGrid(data.data_preview, data.column_info);
                }
            } catch (error) {
                console.error('Failed to check session status:', error);
            }
        },

        async applyOperation(operationType) {
            if (!this.sessionActive) {
                alert('Please initialize a session first');
                return;
            }
            
            console.log('Applying operation:', operationType);
            
            // Create the API call based on operation type
            let endpoint = '';
            let payload = {};
            
            switch (operationType) {
                case 'mean-imputation':
                    endpoint = `/data_tools/api/studio/${window.datasourceId}/transform/imputation/`;
                    payload = {
                        columns: this.getSelectedColumns(),
                        method: 'mean'
                    };
                    break;
                case 'scaling':
                    endpoint = `/data_tools/api/studio/${window.datasourceId}/transform/scaling/`;
                    payload = {
                        columns: this.getSelectedColumns(),
                        scaling_type: this.scalingType
                    };
                    break;
                case 'binning':
                    endpoint = `/data_tools/api/studio/${window.datasourceId}/transform/engineering/`;
                    payload = {
                        new_column_name: 'binned_column',
                        formula_string: `pd.cut(${this.getSelectedColumns()[0]}, bins=${this.numberOfBins})`
                    };
                    break;
                default:
                    alert('Operation not implemented yet');
                    return;
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (result.success) {
                    this.updateSessionStatus(result.session_info);
                    this.updateDataGrid(result.data_preview, result.column_info);
                    this.closeForm();
                    alert(result.message);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Failed to apply operation:', error);
                alert('Failed to apply operation');
            }
        },

        getSelectedColumns() {
            // This is a simplified implementation
            // In a real application, you'd get the selected columns from the form
            return ['column1', 'column2']; // Placeholder
        },

        updateSessionStatus(sessionInfo) {
            this.sessionInfo = sessionInfo;
            this.sessionActive = sessionInfo.session_exists;
            
            const statusIndicator = document.getElementById('session-status-indicator');
            const statusText = document.getElementById('session-status-text');
            const sessionInfoPanel = document.getElementById('session-info');
            
            if (this.sessionActive) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-400';
                statusText.textContent = 'Active session';
                sessionInfoPanel.classList.remove('hidden');
                
                // Update session info details
                document.getElementById('history-info').textContent = `${sessionInfo.history_length} operations`;
                document.getElementById('position-info').textContent = `${sessionInfo.current_position}/${sessionInfo.history_length}`;
                document.getElementById('rows-info').textContent = sessionInfo.current_shape ? sessionInfo.current_shape[0] : '0';
                document.getElementById('columns-info').textContent = sessionInfo.current_shape ? sessionInfo.current_shape[1] : '0';
                
                // Enable/disable buttons
                document.getElementById('initialize-session-btn').style.display = 'none';
                document.getElementById('undo-btn').disabled = sessionInfo.current_position === 0;
                document.getElementById('redo-btn').disabled = sessionInfo.current_position === sessionInfo.history_length;
                document.getElementById('save-session-btn').disabled = false;
                document.getElementById('clear-session-btn').disabled = false;
            } else {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-gray-400';
                statusText.textContent = 'No session';
                sessionInfoPanel.classList.add('hidden');
                
                // Reset buttons
                document.getElementById('initialize-session-btn').style.display = 'flex';
                document.getElementById('undo-btn').disabled = true;
                document.getElementById('redo-btn').disabled = true;
                document.getElementById('save-session-btn').disabled = true;
                document.getElementById('clear-session-btn').disabled = true;
            }
        },

        updateDataGrid(dataPreview, columnInfo) {
            if (this.gridApi && dataPreview && columnInfo) {
                this.gridApi.setGridOption('columnDefs', columnInfo);
                this.gridApi.setGridOption('rowData', dataPreview);
            }
        },

        initializeGrid() {
            // Initialize AG Grid with the data
            if (window.gridRowData && window.columnDefsData) {
                const gridOptions = {
                    columnDefs: window.columnDefsData,
                    rowData: window.gridRowData,
                    defaultColDef: {
                        resizable: true,
                        sortable: true,
                        filter: true,
                        floatingFilter: true
                    },
                    rowSelection: 'multiple',
                    pagination: true,
                    paginationPageSize: 25,
                    paginationPageSizeSelector: [10, 25, 50, 100],
                    suppressRowClickSelection: true,
                    enableCellTextSelection: true,
                    animateRows: true
                };

                const gridDiv = document.querySelector('#data-preview-grid');
                if (gridDiv) {
                    this.gridApi = agGrid.createGrid(gridDiv, gridOptions);
                }
            }
        },

        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.querySelector('meta[name="csrf-token"]')?.content || '';
        }
    }
}

// Session Management Functions
async function initializeSession() {
    try {
        const response = await fetch(`/data_tools/api/studio/${window.datasourceId}/session/initialize/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const data = await response.json();
        if (data.success) {
            // Update the app state
            const app = Alpine.$data(document.querySelector('[x-data]'));
            app.updateSessionStatus(data.session_info);
            app.updateDataGrid(data.data_preview, data.column_info);
            alert('Session initialized successfully');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to initialize session:', error);
        alert('Failed to initialize session');
    }
}

async function undoOperation() {
    try {
        const response = await fetch(`/data_tools/api/studio/${window.datasourceId}/session/undo/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const data = await response.json();
        if (data.success) {
            const app = Alpine.$data(document.querySelector('[x-data]'));
            app.updateSessionStatus(data.session_info);
            app.updateDataGrid(data.data_preview, data.column_info);
            alert('Operation undone successfully');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to undo operation:', error);
        alert('Failed to undo operation');
    }
}

async function redoOperation() {
    try {
        const response = await fetch(`/data_tools/api/studio/${window.datasourceId}/session/redo/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const data = await response.json();
        if (data.success) {
            const app = Alpine.$data(document.querySelector('[x-data]'));
            app.updateSessionStatus(data.session_info);
            app.updateDataGrid(data.data_preview, data.column_info);
            alert('Operation redone successfully');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to redo operation:', error);
        alert('Failed to redo operation');
    }
}

async function saveSession() {
    const name = prompt('Enter name for the new dataset:', `${window.datasourceName}_transformed`);
    if (!name) return;
    
    const description = prompt('Enter description (optional):');
    
    try {
        const response = await fetch(`/data_tools/api/studio/${window.datasourceId}/session/save/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                name: name,
                description: description || `Transformed version of ${window.datasourceName}`
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Data saved successfully as new datasource: ' + data.new_datasource.name);
            // Session is cleared after save
            const app = Alpine.$data(document.querySelector('[x-data]'));
            app.sessionActive = false;
            app.updateSessionStatus({ session_exists: false });
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to save session:', error);
        alert('Failed to save session');
    }
}

async function clearSession() {
    if (!confirm('Are you sure you want to clear the session? All unsaved changes will be lost.')) {
        return;
    }
    
    try {
        const response = await fetch(`/data_tools/api/studio/${window.datasourceId}/session/clear/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const data = await response.json();
        if (data.success) {
            const app = Alpine.$data(document.querySelector('[x-data]'));
            app.sessionActive = false;
            app.updateSessionStatus({ session_exists: false });
            alert('Session cleared successfully');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to clear session:', error);
        alert('Failed to clear session');
    }
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.content || '';
}
</script>
{% endblock %}
