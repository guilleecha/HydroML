{% extends "core/base.html" %}
{% load static %}
{% load dict_extras %}

{% block page_title %}Data Studio - {{ datasource.name }}{% endblock %}

{% block extra_css %}
<style>
    .data-studio-layout {
        height: calc(100vh - 120px);
        overflow: hidden;
    }
    .left-panel {
        overflow: hidden;
        border-right: 1px solid var(--border-color, #e5e7eb);
    }
    .right-panel {
        overflow-y: auto;
        max-height: 100%;
    }
    
    /* AG Grid header improvements */
    .ag-theme-quartz .ag-header-cell,
    .ag-theme-quartz-dark .ag-header-cell {
        padding: 8px 4px !important;
    }
    
    .ag-theme-quartz .ag-header-cell-text,
    .ag-theme-quartz-dark .ag-header-cell-text {
        margin-bottom: 4px;
    }
    
    .custom-header-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 8px 4px;
    }
    
    .header-text {
        cursor: pointer;
        user-select: none;
        font-weight: 600;
        text-align: center;
        margin-bottom: 4px;
        transition: color 0.2s ease;
    }
    
    .header-text:hover {
        color: var(--ag-accent-color, #3b82f6);
    }
    
    /* One Dark theme specific styles */
    .dark .ag-theme-quartz-dark {
        --ag-background-color: #282c34;
        --ag-foreground-color: #abb2bf;
        --ag-border-color: #3e4451;
        --ag-header-background-color: #2c313c;
        --ag-odd-row-background-color: #2c313c;
        --ag-accent-color: #61afef;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex-1">
    <!-- Header Section with Breadcrumbs -->
    <div class="border-b border-border-default dark:border-onedark-border bg-background-primary dark:bg-onedark-background px-8 py-6">
        <!-- Breadcrumbs -->
        {% if breadcrumbs %}
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                {% for crumb in breadcrumbs %}
                    {% if not forloop.last %}
                        <li>
                            <a href="{{ crumb.url }}" class="text-foreground-muted hover:text-foreground-primary transition-colors">
                                {{ crumb.name }}
                            </a>
                        </li>
                        <li class="text-foreground-muted">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </li>
                    {% else %}
                        <li class="text-foreground-primary font-medium">{{ crumb.name }}</li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>
        {% endif %}
        
        <!-- Header Title -->
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-background-secondary rounded-xl flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.78 0-2.678-2.153-1.415-3.414l5-5A2 2 0 009 11.172V5l-1-1z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-foreground-default">Data Studio</h1>
                    <p class="text-foreground-muted">{{ datasource.name }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Two-Panel Layout -->
    <div class="data-studio-layout flex">
        <!-- Left Panel - Data Grid (75%) -->
        <div class="left-panel flex-1" style="flex: 0 0 75%;">
            <div class="h-full flex flex-col">
                <!-- Grid Header -->
                <div class="bg-background-primary border-b border-border-default px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-foreground-default">Interactive Data Preview</h2>
                            <p class="text-sm text-foreground-muted">Select columns using checkboxes to perform operations</p>
                        </div>
                        <div class="text-sm text-foreground-muted">
                            <span id="selected-count">0</span> columns selected
                        </div>
                    </div>
                </div>
                
                <!-- AG Grid Container -->
                <div class="flex-1 p-6">
                    <div id="data-preview-grid" 
                         class="h-full w-full"
                         :class="darkMode ? 'ag-theme-quartz-dark' : 'ag-theme-quartz'"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Action Tools (25%) -->
        <div class="right-panel bg-background-secondary" style="flex: 0 0 25%; min-width: 350px;">
            <form method="post" id="data-studio-form" class="h-full flex flex-col">
                {% csrf_token %}
                
                <!-- Action Panel Header -->
                <div class="bg-background-primary border-b border-border-default px-6 py-4">
                    <h3 class="text-lg font-semibold text-foreground-default">Data Operations</h3>
                    <p class="text-sm text-foreground-muted">Transform and prepare your dataset</p>
                </div>
                
                <!-- Action Sections -->
                <div class="flex-1 p-6 space-y-6 overflow-y-auto">
                    
                    <!-- Section 1: Column Management -->
                    <div class="bg-background-primary border border-border-default rounded-lg shadow-sm">
                        <div class="px-4 py-3 border-b border-border-default">
                            <h4 class="text-base font-semibold text-foreground-default flex items-center">
                                <svg class="w-5 h-5 mr-2 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Gestión de Columnas
                            </h4>
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-foreground-muted mb-4">
                                Selecciona columnas en la tabla y elimínalas del dataset.
                            </p>
                            
                            <!-- Hidden input for removed columns -->
                            <input type="hidden" id="removed_columns_input" name="removed_columns" value="[]">
                            
                            <!-- Selected columns display -->
                            <div class="mb-4">
                                <div class="text-sm text-foreground-muted mb-2">Columnas seleccionadas:</div>
                                <div id="selected-columns-list" class="min-h-[40px] bg-background-secondary border border-border-default rounded-lg p-3 text-sm">
                                    <span class="text-foreground-muted italic">Ninguna columna seleccionada</span>
                                </div>
                            </div>
                            
                            <!-- Remove button -->
                            <button type="button" id="remove-selected-columns-btn" 
                                    class="w-full px-4 py-2 bg-danger-600 hover:bg-danger-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Eliminar Columnas Seleccionadas
                            </button>
                        </div>
                    </div>

                    <!-- Section 2: Feature Engineering -->
                    <div class="bg-background-primary border border-border-default rounded-lg shadow-sm">
                        <div class="px-4 py-3 border-b border-border-default">
                            <h4 class="text-base font-semibold text-foreground-default flex items-center">
                                <svg class="w-5 h-5 mr-2 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 011-1h1a2 2 0 100-4H7a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path>
                                </svg>
                                Feature Engineering
                            </h4>
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-foreground-muted mb-4">
                                Aplica transformaciones automáticas a los datos.
                            </p>
                            
                            <!-- Transformation Type Selector -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-foreground-default mb-2">
                                    Tipo de Transformación
                                </label>
                                <select id="transformation_type" name="transformation_type" 
                                        class="w-full px-3 py-2 bg-background-primary border border-border-default rounded-lg text-foreground-default focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                                    <option value="">Seleccionar transformación...</option>
                                    <option value="mean_median_imputer">Imputación (Media/Mediana)</option>
                                    <option value="onehot_encoder">Codificación One-Hot</option>
                                    <option value="equal_frequency_discretiser">Discretización por Frecuencia</option>
                                </select>
                            </div>
                            
                            <!-- Transformation Parameters -->
                            <div id="transformation_parameters" class="mb-4 hidden">
                                <!-- Parameters will be populated by JavaScript -->
                            </div>
                            
                            <!-- Apply Transformation Button -->
                            <button type="button" id="apply_transformation_btn" 
                                    class="w-full px-4 py-2 bg-success-600 hover:bg-success-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Aplicar Transformación
                            </button>
                            
                            <!-- Transformation History -->
                            <div id="transformation_history" class="mt-4 hidden">
                                <div class="text-sm font-medium text-foreground-default mb-2">Transformaciones Aplicadas:</div>
                                <div id="history_list" class="space-y-1">
                                    <!-- History items will be added by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Data Type Configuration -->
                    <div class="bg-background-primary border border-border-default rounded-lg shadow-sm">
                        <div class="px-4 py-3 border-b border-border-default">
                            <h4 class="text-base font-semibold text-foreground-default flex items-center">
                                <svg class="w-5 h-5 mr-2 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                Tipos de Datos
                            </h4>
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-foreground-muted mb-4">
                                Configura los tipos de datos para cada columna.
                            </p>
                            
                            <div class="space-y-3 max-h-60 overflow-y-auto">
                                {% for col_name in column_info.keys %}
                                <div class="flex items-center space-x-3 p-2 bg-background-secondary rounded-lg">
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-foreground-default truncate">{{ col_name }}</div>
                                        <div class="text-xs text-foreground-muted">
                                            {% with column_info|get_item:col_name as col_data %}
                                                {{ col_data.pandas_dtype|default:"Unknown" }}
                                            {% endwith %}
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <select name="type-{{ col_name }}" 
                                                class="text-xs px-2 py-1 bg-background-primary border border-border-default rounded focus:ring-1 focus:ring-brand-500">
                                            <option value="">Mantener</option>
                                            <option value="object">Texto</option>
                                            <option value="int64">Entero</option>
                                            <option value="float64">Decimal</option>
                                            <option value="datetime64[ns]">Fecha</option>
                                        </select>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Column Analysis -->
                    <div class="bg-background-primary border border-border-default rounded-lg shadow-sm">
                        <div class="px-4 py-3 border-b border-border-default">
                            <h4 class="text-base font-semibold text-foreground-default flex items-center">
                                <svg class="w-5 h-5 mr-2 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4"></path>
                                </svg>
                                Análisis de Columnas
                            </h4>
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-foreground-muted mb-4">
                                Genera gráficos interactivos para analizar columnas numéricas.
                            </p>
                            
                            <div class="space-y-3">
                                <div>
                                    <label for="analysis_column_select" class="block text-sm font-medium text-foreground-default mb-2">
                                        Seleccionar Columna Numérica
                                    </label>
                                    <select id="analysis_column_select" 
                                            class="w-full px-3 py-2 bg-background-primary border border-border-default rounded-lg text-foreground-default focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                                        <option value="">Seleccione una columna...</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="chart_type_select" class="block text-sm font-medium text-foreground-default mb-2">
                                        Tipo de Gráfico
                                    </label>
                                    <select id="chart_type_select" 
                                            class="w-full px-3 py-2 bg-background-primary border border-border-default rounded-lg text-foreground-default focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                                        <option value="histogram">Histograma</option>
                                        <option value="boxplot">Diagrama de Caja</option>
                                    </select>
                                </div>
                                
                                <button type="button" id="generate_chart_btn" 
                                        class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        disabled>
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4"></path>
                                    </svg>
                                    Generar Gráfico
                                </button>
                            </div>
                            
                            <!-- Chart Container -->
                            <div id="chart_container" class="mt-4 hidden">
                                <div class="border border-border-default rounded-lg p-4 bg-background-secondary">
                                    <div id="chart_content" class="min-h-[400px]">
                                        <!-- Chart will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loading indicator -->
                            <div id="chart_loading" class="mt-4 hidden">
                                <div class="flex items-center justify-center py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-600"></div>
                                    <span class="ml-2 text-sm text-foreground-muted">Generando gráfico...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer Actions -->
                <div class="border-t border-border-default bg-background-primary px-6 py-4">
                    <!-- New Dataset Name -->
                    <div class="mb-4">
                        <label for="new_dataset_name" class="block text-sm font-medium text-foreground-default mb-2">
                            Nombre del Nuevo Dataset
                        </label>
                        <input type="text" id="new_dataset_name" name="new_dataset_name" 
                               value="{{ datasource.name }} (Preparado)"
                               class="w-full px-3 py-2 bg-background-primary border border-border-default rounded-lg text-foreground-default focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                    </div>
                    
                    <!-- Save Button -->
                    <button type="submit" 
                            class="w-full px-6 py-3 bg-brand-600 hover:bg-brand-700 text-white font-semibold rounded-lg transition-colors">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        Guardar como Nueva Fuente de Datos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="{% static 'data_tools/js/data_studio.js' %}"></script>

<script>
// Make data available to JavaScript
window.gridRowData = {{ grid_data_json|safe }};
window.columnDefsData = {{ column_defs_json|safe }};
window.datasourceId = "{{ datasource.id }}";
</script>
{% endblock %}
