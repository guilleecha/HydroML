<!-- Export Button - Pure JavaScript Component (Alpine.js Free) -->
<!-- Integra con Data Studio sin Alpine.js para evitar problemas de persistencia -->
<div id="export-button-wrapper" class="export-button-wrapper">
    <!-- Main Export Button -->
    <button 
        id="main-export-button"
        onclick="exportButton.openExportModal()" 
        class="w-full flex items-center justify-center px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md text-sm font-medium transition-colors space-x-2 group"
        title="Export current dataset">
        <svg class="w-4 h-4 transition-transform group-hover:scale-105" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
        </svg>
        <span id="export-button-text">Export Data</span>
        <span id="export-button-loading" class="flex items-center space-x-1" style="display: none;">
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Exporting...</span>
        </span>
    </button>

    <!-- Quick Export Actions (collapsed by default) -->
    <div id="quick-actions-panel" style="display: none; margin-top: 8px; transform-origin: top;">
        <div class="grid grid-cols-3 gap-1 text-xs">
            <button 
                onclick="exportButton.quickExport('csv')" 
                class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors quick-export-btn">
                CSV
            </button>
            <button 
                onclick="exportButton.quickExport('json')" 
                class="px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded transition-colors quick-export-btn">
                JSON
            </button>
            <button 
                onclick="exportButton.quickExport('excel')" 
                class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded transition-colors quick-export-btn">
                Excel
            </button>
        </div>
    </div>

    <!-- Toggle Quick Actions -->
    <button 
        id="toggle-quick-actions"
        onclick="exportButton.toggleQuickActions()"
        class="w-full mt-1 flex items-center justify-center px-2 py-1 text-xs text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
        <svg id="quick-actions-arrow" class="w-3 h-3 transform transition-transform" 
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
        <span class="ml-1">Quick Export</span>
    </button>
</div>

<script>
// Export Button - Pure JavaScript Implementation (No Alpine.js)
class ExportButtonManager {
    constructor() {
        this.isExporting = false;
        this.showQuickActions = false;
        
        this.init();
    }

    init() {
        console.log('ðŸ§ª Export Button Init: Starting initialization (Pure JS)...');
        
        try {
            // Make this component globally accessible
            window.exportButton = this;
            
            console.log('âœ… Export Button Init: Pure JavaScript initialization completed successfully');
            
        } catch (error) {
            console.error('âŒ Export Button Init: Initialization failed:', error);
            if (window.DataStudioErrorHandler) {
                window.DataStudioErrorHandler.handleFatalError(error, {
                    component: 'export-button',
                    operation: 'component_initialization'
                });
            }
        }
    }

    openExportModal() {
        // Trigger the main export modal
        if (window.exportWizard) {
            window.exportWizard.open();
        } else {
            console.warn('Export wizard not initialized');
            this.showAlert('Export wizard is not available', 'error');
        }
    }

    toggleQuickActions() {
        this.showQuickActions = !this.showQuickActions;
        
        const panel = document.getElementById('quick-actions-panel');
        const arrow = document.getElementById('quick-actions-arrow');
        
        if (panel && arrow) {
            if (this.showQuickActions) {
                panel.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                panel.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
    }

    setExportingState(isExporting) {
        this.isExporting = isExporting;
        
        const mainButton = document.getElementById('main-export-button');
        const buttonText = document.getElementById('export-button-text');
        const buttonLoading = document.getElementById('export-button-loading');
        const quickButtons = document.querySelectorAll('.quick-export-btn');
        
        if (mainButton) {
            mainButton.disabled = isExporting;
        }
        
        if (buttonText && buttonLoading) {
            if (isExporting) {
                buttonText.style.display = 'none';
                buttonLoading.style.display = 'flex';
            } else {
                buttonText.style.display = 'inline';
                buttonLoading.style.display = 'none';
            }
        }
        
        // Disable quick export buttons when exporting
        quickButtons.forEach(btn => {
            btn.disabled = isExporting;
        });
    }

    async quickExport(format) {
        this.setExportingState(true);
        
        try {
            // Get current data and filters
            const data = {
                datasource_id: window.datasourceId,
                format: format,
                filters: this.getCurrentFilters(),
                options: {
                    include_headers: true,
                    scope: 'filtered',
                    quick_export: true
                }
            };

            const response = await this.createExportJob(data);
            if (response.success) {
                // Start monitoring the export job
                this.monitorExportJob(response.data.id);
                
                // Show success message
                this.showAlert('Export started successfully', 'success');
            } else {
                throw new Error(response.message || 'Export failed');
            }
        } catch (error) {
            console.error('Quick export failed:', error);
            this.showAlert(error.message || 'Export failed', 'error');
            this.setExportingState(false);
        }
    }

    getCurrentFilters() {
        // Get current filters from available grid systems
        
        // Try AG Grid first (legacy compatibility)
        const gridApi = window.gridApi;
        if (gridApi && typeof gridApi.getFilterModel === 'function') {
            return gridApi.getFilterModel();
        }
        
        // Try TanStack Table
        if (window.tanStackTableCoordinator && window.tanStackTableCoordinator.isReady()) {
            const controller = window.tanStackTableCoordinator.getController();
            return {
                globalFilter: controller.globalFilter || ''
            };
        }
        
        return {};
    }

    async createExportJob(data) {
        const response = await fetch('/tools/api/v1/exports/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken()
            },
            body: JSON.stringify(data)
        });
        return await response.json();
    }

    async monitorExportJob(jobId) {
        const checkStatus = async () => {
            try {
                const response = await fetch(`/tools/api/v1/exports/${jobId}/`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const job = result.data;
                    
                    if (job.status === 'completed') {
                        // Auto-download the file
                        this.downloadFile(jobId);
                        this.showAlert('Export completed successfully!', 'success');
                        this.setExportingState(false);
                    } else if (job.status === 'failed') {
                        this.showAlert(`Export failed: ${job.error_message}`, 'error');
                        this.setExportingState(false);
                    } else if (job.status === 'processing' || job.status === 'pending') {
                        // Continue monitoring
                        setTimeout(checkStatus, 2000);
                    }
                }
            } catch (error) {
                console.error('Error monitoring export job:', error);
                this.setExportingState(false);
            }
        };
        
        setTimeout(checkStatus, 1000);
    }

    downloadFile(jobId) {
        // Trigger download
        const downloadUrl = `/tools/api/v1/exports/${jobId}/download/`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    showAlert(message, type) {
        // Show alert using existing notification system or create simple alert
        if (window.DataStudioErrorHandler) {
            if (type === 'success') {
                console.log(`âœ… ${message}`);
            } else {
                console.warn(`âš ï¸ ${message}`);
            }
        } else {
            // Fallback to console
            console.log(`${type.toUpperCase()}: ${message}`);
        }
        
        // Optional: Create a simple toast notification
        this.createToastNotification(message, type);
    }

    createToastNotification(message, type) {
        // Create a simple toast notification
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md text-white text-sm font-medium transition-opacity duration-300 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        }`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (toast.parentNode) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    }
}

// Initialize export button when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.exportButtonManager = new ExportButtonManager();
});
</script>