{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="max-w-5xl mx-auto py-8">
    <!-- Contenedor para la alerta de error -->
    <div id="task-error-alert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
        <span class="block sm:inline"></span>
    </div>

    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-800">{{ experiment.name }}</h1>
        {% if experiment.status == "COMPLETED" %}
            <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm font-semibold">{{ experiment.get_status_display }}</span>
        {% elif experiment.status == "FINISHED" %}
            <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-semibold">{{ experiment.get_status_display }}</span>
        {% elif experiment.status == "PROCESSING" %}
            <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-sm font-semibold">{{ experiment.get_status_display }}</span>
        {% else %}
            <span class="px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-sm font-semibold">{{ experiment.get_status_display }}</span>
        {% endif %}
    </div>

    <div class="bg-white shadow rounded-lg p-4 mb-8 flex flex-wrap gap-4">
        <form method="post" action="{% url 'experiments:trigger_split_task' experiment_id=experiment.pk %}">
            {% csrf_token %}
            <button type="submit"
                class="px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 disabled:bg-gray-300"
                {% if experiment.status not in "DRAFT,FAILED" %}disabled{% endif %}>
                Ejecutar División Train/Test
            </button>
        </form>
        <form method="post" action="{% url 'experiments:trigger_training_task' experiment_id=experiment.pk %}">
            {% csrf_token %}
            <button type="submit"
                class="px-4 py-2 rounded bg-indigo-600 text-white font-semibold hover:bg-indigo-700 disabled:bg-gray-300"
                {% if experiment.status != "SPLIT" %}disabled{% endif %}>
                Ejecutar Validación del Modelo
            </button>
        </form>
        <form method="post" action="{% url 'experiments:trigger_final_evaluation_task' experiment_id=experiment.pk %}">
            {% csrf_token %}
            <button type="submit"
                class="px-4 py-2 rounded bg-green-600 text-white font-semibold hover:bg-green-700 disabled:bg-gray-300"
                {% if experiment.status != "COMPLETED" %}disabled{% endif %}>
                Ejecutar Test Final
            </button>
        </form>
        <form method="post" action="{% url 'experiments:trigger_feature_importance_task' experiment_id=experiment.pk %}">
            {% csrf_token %}
            <button type="submit"
                class="px-4 py-2 rounded bg-yellow-600 text-white font-semibold hover:bg-yellow-700 disabled:bg-gray-300"
                {% if experiment.status != "FINISHED" %}disabled{% endif %}>
                Calcular Importancia de Variables
            </button>
        </form>
    </div>

    <div class="border-b border-gray-200 mb-6">
        <nav class="flex space-x-8" aria-label="Tabs">
            <button id="tab-results-btn" class="py-4 px-1 text-sm font-medium text-blue-600 border-b-2 border-blue-600 focus:outline-none" type="button">
                Resultados y Gráficos
            </button>
            <button id="tab-config-btn" class="py-4 px-1 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 focus:outline-none" type="button">
                Configuración Detallada
            </button>
        </nav>
    </div>

    <div id="tab-results" class="">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-2">Validación Cruzada</h2>
                {% if experiment.results.mean_nse %}
                    <div class="text-gray-700 mb-1">NSE Promedio: <span class="font-semibold">{{ experiment.results.mean_nse|floatformat:3 }}</span>
                        {% if experiment.results.std_nse %}
                            &plusmn; <span class="text-xs">{{ experiment.results.std_nse|floatformat:3 }}</span>
                        {% endif %}
                    </div>
                {% endif %}
                {% if experiment.results.mean_rmse %}
                    <div class="text-gray-700 mb-1">RMSE Promedio: <span class="font-semibold">{{ experiment.results.mean_rmse|floatformat:3 }}</span></div>
                {% endif %}
                {% if not experiment.results.mean_nse and not experiment.results.mean_rmse %}
                    <div class="text-gray-400">No hay resultados de validación cruzada disponibles.</div>
                {% endif %}
            </div>
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-2">Test Final</h2>
                {% if experiment.results.final_r2 %}
                    <div class="text-gray-700 mb-1">R² Final: <span class="font-semibold">{{ experiment.results.final_r2|floatformat:3 }}</span></div>
                {% endif %}
                {% if experiment.results.final_rmse %}
                    <div class="text-gray-700 mb-1">RMSE Final: <span class="font-semibold">{{ experiment.results.final_rmse|floatformat:3 }}</span></div>
                {% endif %}
                {% if not experiment.results.final_r2 and not experiment.results.final_rmse %}
                    <div class="text-gray-400">No hay resultados de test final disponibles.</div>
                {% endif %}
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% if experiment.results.prediction_plot %}
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-2">Predicciones vs. Reales</h2>
                <img src="{{ experiment.results.prediction_plot.url }}" alt="Predicciones vs. Reales" class="w-full rounded">
            </div>
            {% endif %}
            {% if experiment.results.feature_importance_plot %}
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-2">Importancia de Variables</h2>
                <img src="{{ experiment.results.feature_importance_plot.url }}" alt="Importancia de Variables" class="w-full rounded">
            </div>
            {% endif %}
        </div>
    </div>

    <div id="tab-config" class="hidden">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Configuración del Experimento</h2>
            <ul class="space-y-2">
                <li><span class="font-semibold text-gray-700">Fuente de Datos:</span> {{ experiment.input_datasource.name }}</li>
                <li><span class="font-semibold text-gray-700">Modelo:</span> {{ experiment.model_name }}</li>
                <li><span class="font-semibold text-gray-700">Variable Objetivo:</span> {{ experiment.target_column }}</li>
                <li><span class="font-semibold text-gray-700">Variables Predictoras:</span>
                    {% for feature in experiment.feature_set %}
                        <span class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded mr-1 text-xs">{{ feature }}</span>
                    {% empty %}
                        <span class="text-gray-400">No especificadas</span>
                    {% endfor %}
                </li>
                <li><span class="font-semibold text-gray-700">Hiperparámetros:</span>
                    {% if experiment.hyperparameters %}
                        <pre class="bg-gray-50 p-2 rounded text-xs text-gray-700">{{ experiment.hyperparameters|safe }}</pre>
                    {% else %}
                        <span class="text-gray-400">No especificados</span>
                    {% endif %}
                </li>
            </ul>
        </div>
    </div>

    {% if experiment.status == 'FINISHED' %}
    <div class="mt-8">
        <button onclick="location.href='{% url 'trigger_feature_importance_task' experiment.id %}'"
            class="px-4 py-2 rounded bg-yellow-600 text-white font-semibold hover:bg-yellow-700">
            Analizar Modelo
        </button>
    </div>
    {% endif %}

    {% if experiment.results.feature_importance %}
    <div class="mt-8">
        <h3 class="text-lg font-bold text-gray-800 mb-2">Importancia de Variables</h3>
        <canvas id="featureImportanceChart"></canvas>
    </div>
    {% endif %}

    <div id="loading" class="hidden mt-4 text-center">
        <p class="text-gray-600">Calculando la importancia de variables... Por favor, espera.</p>
    </div>

    <script>
        document.querySelector('form[action*="trigger_feature_importance_task"]').addEventListener('submit', function() {
            document.getElementById('loading').classList.remove('hidden');
        });
    </script>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabResultsBtn = document.getElementById('tab-results-btn');
    const tabConfigBtn = document.getElementById('tab-config-btn');
    const tabResults = document.getElementById('tab-results');
    const tabConfig = document.getElementById('tab-config');

    tabResultsBtn.addEventListener('click', function() {
        tabResults.classList.remove('hidden');
        tabConfig.classList.add('hidden');
        tabResultsBtn.classList.add('text-blue-600', 'border-blue-600');
        tabConfigBtn.classList.remove('text-blue-600', 'border-blue-600');
        tabConfigBtn.classList.add('text-gray-500', 'border-transparent');
    });

    tabConfigBtn.addEventListener('click', function() {
        tabResults.classList.add('hidden');
        tabConfig.classList.remove('hidden');
        tabConfigBtn.classList.add('text-blue-600', 'border-blue-600');
        tabResultsBtn.classList.remove('text-blue-600', 'border-blue-600');
        tabResultsBtn.classList.add('text-gray-500', 'border-transparent');
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    {% if experiment.results.feature_importance %}
    const featureImportanceData = {{ experiment.results.feature_importance|safe }};
    const topFeatures = featureImportanceData.slice(0, 10);  // Mostrar solo las 10 más importantes
    const labels = topFeatures.map(item => item.feature);
    const data = topFeatures.map(item => item.importance);

    const ctx = document.getElementById('featureImportanceChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Importancia',
                data: data,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}