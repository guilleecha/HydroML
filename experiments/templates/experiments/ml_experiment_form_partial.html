{% load static %}
{% load tailwind_filters %}

<!-- New Experiment Form - Partial Template for Slide-Over Panel -->
<form method="post" id="experiment-form" 
      class="space-y-6"
      data-get-columns-url-template="{% url 'data_tools:get_columns_api' datasource_id='00000000-0000-0000-0000-000000000000' %}"
      @submit.prevent="submitExperimentForm($event)">
    
    {% csrf_token %}
    
    {% if form.errors %}
        <div class="p-4 mb-4 text-sm text-red-800 dark:text-darcula-error rounded-lg bg-red-100 dark:bg-darcula-background-lighter border border-red-400 dark:border-darcula-error" role="alert">
            <div class="flex items-center mb-2">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <span class="font-bold">Errores de validación:</span>
            </div>
            <ul class="list-disc list-inside space-y-1">
                {% for field, errors in form.errors.items %}
                    {% if field == '__all__' %}
                        {% for error in errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% else %}
                        <li><strong>{{ field }}:</strong> {{ errors|striptags }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% if form.warnings %}
        <div class="p-4 mb-4 text-sm text-yellow-800 dark:text-yellow-200 rounded-lg bg-yellow-100 dark:bg-yellow-900/20 border border-yellow-400 dark:border-yellow-700" role="alert">
            <div class="flex items-center mb-2">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span class="font-bold">Advertencias (el experimento puede continuar):</span>
            </div>
            <ul class="list-disc list-inside space-y-1">
                {% for warning in form.warnings %}
                    <li>{{ warning }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {{ form.name|as_crispy_field }}
    {{ form.description|as_crispy_field }}
    
    <!-- Workspace Selection -->
    <div x-data="workspaceSelector()" class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Workspace de Destino</h3>
        
        <div x-show="availableWorkspaces.length <= 5">
            <!-- Radio buttons for ≤5 workspaces -->
            <div class="space-y-3">
                <template x-for="workspace in availableWorkspaces" :key="workspace.id">
                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800">
                        <input type="radio" 
                               name="project" 
                               :value="workspace.id" 
                               x-model="selectedProjectId"
                               class="mr-3 text-blue-600 focus:ring-blue-500">
                        <div>
                            <div class="font-medium text-gray-900 dark:text-gray-100" x-text="workspace.name"></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400" x-text="workspace.description || 'Sin descripción'"></div>
                        </div>
                    </label>
                </template>
            </div>
        </div>
        
        <div x-show="availableWorkspaces.length > 5">
            <!-- Dropdown for >5 workspaces -->
            {{ form.project|as_crispy_field }}
        </div>
        
        <!-- Show message if no workspaces -->
        <div x-show="availableWorkspaces.length === 0" class="p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg">
            <p class="text-sm text-yellow-800 dark:text-yellow-200">No tienes workspaces disponibles. <a href="#" class="font-medium underline">Crear nuevo workspace</a></p>
        </div>
    </div>
    
    {{ form.input_datasource|as_crispy_field }}

    <div>
        <label for="id_target_column_select" class="block text-sm font-medium text-foreground-default dark:text-darcula-foreground mb-1">Variable Objetivo</label>
        <select id="id_target_column_select" name="target_column_select" class="block w-full border-border-default dark:border-darcula-border bg-background-primary dark:bg-darcula-background text-foreground-default dark:text-darcula-foreground rounded-md shadow-sm" disabled>
            <option value="">Primero selecciona una Fuente de Datos</option>
        </select>
    </div>

    <div class="mt-4">
        <fieldset class="border border-border-default dark:border-darcula-border rounded-md p-4">
            <legend class="block text-sm font-medium text-foreground-default dark:text-darcula-foreground px-2">Selección de Variables Predictoras</legend>
            <div class="grid grid-cols-12 gap-4 mt-1">
                <div class="col-span-5">
                    <label for="features-available" class="text-xs font-semibold text-foreground-muted dark:text-darcula-foreground-muted block mb-1">Disponibles</label>
                    <select id="features-available" multiple class="w-full h-40 border-border-default dark:border-darcula-border bg-background-primary dark:bg-darcula-background text-foreground-default dark:text-darcula-foreground rounded-md" aria-label="Variables disponibles para seleccionar"></select>
                </div>
                <div class="col-span-2 flex flex-col items-center justify-center space-y-2">
                    <button type="button" id="btn-add-feature" class="px-3 py-1.5 border border-border-default dark:border-darcula-border bg-background-primary dark:bg-darcula-background-lighter text-foreground-default dark:text-darcula-foreground rounded-md shadow-sm hover:bg-background-secondary dark:hover:bg-darcula-background" aria-label="Agregar variables seleccionadas">&gt;&gt;</button>
                    <button type="button" id="btn-remove-feature" class="px-3 py-1.5 border border-border-default dark:border-darcula-border bg-background-primary dark:bg-darcula-background-lighter text-foreground-default dark:text-darcula-foreground rounded-md shadow-sm hover:bg-background-secondary dark:hover:bg-darcula-background" aria-label="Remover variables seleccionadas">&lt;&lt;</button>
                </div>
                <div class="col-span-5">
                    <label for="features-selected" class="text-xs font-semibold text-foreground-muted dark:text-darcula-foreground-muted block mb-1">Seleccionadas</label>
                    <select id="features-selected" multiple class="w-full h-40 border-border-default dark:border-darcula-border bg-background-primary dark:bg-darcula-background text-foreground-default dark:text-darcula-foreground rounded-md" aria-label="Variables seleccionadas para el modelo"></select>
                </div>
            </div>
        </fieldset>
    </div>
    
    {{ form.model_name|as_crispy_field }}
    
    <div id="rf-fields" class="hidden space-y-4 mt-4 p-4 border border-border-default dark:border-darcula-border rounded-md bg-background-secondary dark:bg-darcula-background-lighter">
        <h4 class="font-semibold text-foreground-default dark:text-darcula-keyword">Hiperparámetros de Random Forest</h4>
        {{ form.rf_n_estimators|as_crispy_field }}
        {{ form.rf_max_depth|as_crispy_field }}
    </div>
    <div id="gb-fields" class="hidden space-y-4 mt-4 p-4 border border-border-default dark:border-darcula-border rounded-md bg-background-secondary dark:bg-darcula-background-lighter">
        <h4 class="font-semibold text-foreground-default dark:text-darcula-keyword">Hiperparámetros de Gradient Boosting</h4>
        {{ form.gb_n_estimators|as_crispy_field }}
        {{ form.gb_learning_rate|as_crispy_field }}
    </div>

    {{ form.split_strategy|as_crispy_field }}
    
    <!-- Custom Test Split Size Slider with Alpine.js -->
    <div x-data="{ 
        splitValue: {{ form.test_split_size.value|default:20 }}, 
        get splitValueDecimal() { return this.splitValue / 100; } 
    }" class="mb-4">
        <label for="test_split_slider" class="block text-sm font-medium text-foreground-default dark:text-darcula-foreground mb-2">
            Tamaño del Conjunto de Prueba: <span x-text="splitValue + '%'" class="font-semibold text-brand-600 dark:text-darcula-accent"></span>
        </label>
        <div class="flex items-center space-x-4">
            <span class="text-sm text-foreground-muted dark:text-darcula-foreground-muted">5%</span>
            <input 
                type="range" 
                id="test_split_slider"
                min="5" 
                max="50" 
                step="1"
                x-model="splitValue"
                class="flex-1 h-2 bg-background-secondary dark:bg-darcula-background-lighter rounded-lg appearance-none cursor-pointer slider"
                x-on:input="$el.style.setProperty('--value', ($event.target.value - 5) / (50 - 5) * 100 + '%'); $el.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${($event.target.value - 5) / (50 - 5) * 100}%, #e5e7eb ${($event.target.value - 5) / (50 - 5) * 100}%, #e5e7eb 100%)`"
                x-init="$el.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${(splitValue - 5) / (50 - 5) * 100}%, #e5e7eb ${(splitValue - 5) / (50 - 5) * 100}%, #e5e7eb 100%)`"
                aria-label="Seleccionar porcentaje del conjunto de prueba"
            >
            <span class="text-sm text-foreground-muted dark:text-darcula-foreground-muted">50%</span>
        </div>
        <!-- Hidden input to send the actual value to Django -->
        <input 
            type="hidden" 
            name="test_split_size" 
            id="id_test_split_size"
            x-model="splitValueDecimal"
            aria-hidden="true"
        >
    </div>
    
    {{ form.split_random_state|as_crispy_field }}

    <div class="hidden">
        {{ form.target_column }}
        {{ form.feature_set }}
    </div>
    
    <!-- Form Actions -->
    <div class="border-t border-border-default dark:border-darcula-border pt-6 flex justify-end space-x-2">
        <button type="button" 
                @click="isNewExperimentPanelOpen = false"
                class="px-4 py-2 border border-border-default dark:border-darcula-border text-sm font-medium rounded-md text-foreground-default dark:text-darcula-foreground bg-background-primary dark:bg-darcula-background hover:bg-background-tertiary dark:hover:bg-darcula-background-lighter">
            Cancelar
        </button>
        <button type="submit" class="px-4 py-2 bg-brand-600 dark:bg-darcula-accent text-white dark:text-darcula-background font-bold rounded-lg hover:bg-brand-700 dark:hover:bg-darcula-keyword">
            Guardar Experimento
        </button>
    </div>
</form>

<!-- 
Note: JavaScript initialization is handled by app.js initializeMLExperimentFormLogic()
No need to load ml_experiment_form.js here as it conflicts with dynamic loading
-->
