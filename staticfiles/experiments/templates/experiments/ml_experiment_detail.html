{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="mx-auto py-8">
    <div id="task-error-alert" class="mb-4"></div>

    <!-- Header Section -->
    {% include 'experiments/partials/_experiment_header.html' %}

    <!-- Main Grid Layout -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <!-- Configuration Card -->
        {% include 'experiments/partials/_experiment_config_card.html' %}

        <!-- Metrics Card -->
        {% include 'experiments/partials/_experiment_metrics_card.html' %}

        <!-- Interpretability Card -->
        {% include 'experiments/partials/_experiment_interpretability_card.html' %}
    </div>

    <!-- Secondary Grid for Charts and Analysis -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
        
        <!-- Charts Card -->
        {% include 'experiments/partials/_experiment_charts_card.html' %}

        <!-- Artifacts Card -->
        {% include 'experiments/partials/_experiment_artifacts_card.html' %}

        <!-- Lineage Card -->
        {% include 'experiments/partials/_experiment_lineage_card.html' %}

        <!-- Report Card -->
        {% include 'experiments/partials/_experiment_report_card.html' %}
    </div>

    <!-- Actions Section -->
    {% include 'experiments/partials/_experiment_actions.html' %}

    <!-- Legacy tabs (hidden but kept for backwards compatibility) -->
    <div class="hidden">
        <div id="tab-interpretability" class="hidden bg-white dark:bg-darcula-background-lighter rounded-xl border border-border-default shadow-card p-6">
            {% if experiment.status == 'FINISHED' and experiment.artifact_paths.shap_summary %}
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-foreground-default dark:text-darcula-foreground">Análisis de Interpretabilidad (SHAP)</h3>
                    <div class="flex items-center text-sm text-foreground-muted dark:text-darcula-foreground-muted">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        SHAP Values Analysis
                    </div>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-foreground-muted dark:text-darcula-foreground-muted mb-4">
                        Este gráfico muestra la importancia de cada característica y cómo sus valores impactan en las predicciones del modelo. 
                        Los puntos de mayor intensidad representan valores más altos de la característica, mientras que la posición horizontal 
                        indica si la característica contribuye positiva o negativamente a la predicción.
                    </p>
                </div>
                
                <!-- SHAP Summary Plot -->
                <div class="bg-white dark:bg-darcula-background rounded-lg border border-border-default dark:border-darcula-border p-4">
                    <div class="flex justify-center">
                        <img src="{% url 'core:serve_media' path=experiment.artifact_paths.shap_summary %}" 
                             alt="SHAP Summary Plot para {{ experiment.name }}"
                             class="max-w-full h-auto rounded-lg shadow-sm"
                             style="max-height: 600px;">
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Other legacy tabs... -->
        <div id="tab-mlflow-params" class="hidden"></div>
        <div id="tab-mlflow-metrics" class="hidden"></div>
        <div id="tab-artifacts" class="hidden"></div>
        <div id="tab-config" class="hidden"></div>
        <div id="tab-report" class="hidden"></div>
        <div id="tab-lineage" class="hidden"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'experiments/js/experiment_status.js' %}"></script>
    <script src="{% static 'experiments/js/experiment_dashboard.js' %}"></script>
    
    <!-- Tab management -->
    <script src="{% static 'experiments/js/ml_experiment_detail.js' %}"></script>
    
    <!-- Pass experiment data to JavaScript -->
    {% if experiment.status == 'FINISHED' and experiment.results %}
        {% if experiment.results.prediction_data %}
            <script id="prediction-data" type="application/json">{{ experiment.results.prediction_data|safe }}</script>
        {% endif %}
        {% if experiment.results.feature_importance %}
            <script id="feature-importance-data" type="application/json">{{ experiment.results.feature_importance|safe }}</script>
        {% endif %}
    {% endif %}
    
    <script>
        function generateReport(experimentId) {
            // Report generation logic
            console.log('Generating report for experiment:', experimentId);
        }
    </script>
{% endblock %}