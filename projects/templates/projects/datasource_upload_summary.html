{% extends 'core/base.html' %}
{% block content %}
  <div class="container mx-auto px-4 py-8">
    <h2 class="text-3xl font-bold mb-6">Resumen de Carga de Datos</h2>
    
    <div id="status-section">
      <div id="processing-indicator" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6">
        <p class="font-bold">Estado:</p>
        <p id="status">Procesando...</p>
      </div>
    </div>

    <div id="quality-report" style="display:none;">
      <!-- General Statistics -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">
          <p class="font-bold">Filas Detectadas</p>
          <p class="text-2xl" id="rows-count">-</p>
        </div>
        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md" role="alert">
          <p class="font-bold">Columnas Detectadas</p>
          <p class="text-2xl" id="columns-count">-</p>
        </div>
      </div>

      <!-- Data Types Table -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h3 class="text-xl font-semibold mb-4">Tipos de Datos por Columna</h3>
        <table class="w-full text-sm text-left text-gray-700">
          <thead class="text-xs text-gray-800 uppercase bg-gray-100">
            <tr>
              <th scope="col" class="px-6 py-3">Columna</th>
              <th scope="col" class="px-6 py-3">Tipo de Dato Detectado</th>
            </tr>
          </thead>
          <tbody id="data-types-table">
          </tbody>
        </table>
      </div>

      <!-- Missing Values Table -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold mb-4">An√°lisis de Valores Faltantes</h3>
        <table class="w-full text-sm text-left text-gray-700">
          <thead class="text-xs text-gray-800 uppercase bg-gray-100">
            <tr>
              <th scope="col" class="px-6 py-3">Columna</th>
              <th scope="col" class="px-6 py-3">Valores Faltantes</th>
              <th scope="col" class="px-6 py-3">% Faltante</th>
            </tr>
          </thead>
          <tbody id="missing-values-table">
          </tbody>
        </table>
      </div>
    </div>

    <div id="error-section" style="display:none;" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md">
      <p class="font-bold">Error en el procesamiento:</p>
      <p id="error-message"></p>
    </div>
  </div>

  <script>
    const datasourceId = "{{ datasource.id }}";
    const statusEl = document.getElementById('status');
    const processingIndicator = document.getElementById('processing-indicator');
    const qualityReport = document.getElementById('quality-report');
    const errorSection = document.getElementById('error-section');

    async function pollStatus() {
      try {
        const res = await fetch(`{% url 'projects:datasource_upload_summary' datasource_id=datasource.id %}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await res.json();
        statusEl.textContent = data.status;
        
        if (data.status === 'READY') {
          processingIndicator.style.display = 'none';
          qualityReport.style.display = 'block';
          displayQualityReport(data.quality_report);
          return;
        } else if (data.status === 'ERROR') {
          processingIndicator.style.display = 'none';
          errorSection.style.display = 'block';
          document.getElementById('error-message').textContent = data.quality_report?.error || 'Error desconocido';
          return;
        }
      } catch (err) {
        statusEl.textContent = 'Error verificando estado';
        processingIndicator.style.display = 'none';
        errorSection.style.display = 'block';
        document.getElementById('error-message').textContent = err.toString();
        return;
      }
      setTimeout(pollStatus, 2000);
    }

    function displayQualityReport(report) {
      // Update general statistics
      document.getElementById('rows-count').textContent = report.shape[0];
      document.getElementById('columns-count').textContent = report.shape[1];

      // Populate data types table
      const dataTypesTable = document.getElementById('data-types-table');
      dataTypesTable.innerHTML = '';
      for (const [column, dtype] of Object.entries(report.data_types)) {
        const row = document.createElement('tr');
        row.className = 'bg-white border-b hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-6 py-4 font-mono">${column}</td>
          <td class="px-6 py-4 font-mono">${dtype}</td>
        `;
        dataTypesTable.appendChild(row);
      }

      // Populate missing values table
      const missingValuesTable = document.getElementById('missing-values-table');
      missingValuesTable.innerHTML = '';
      const totalRows = report.shape[0];
      for (const [column, missingCount] of Object.entries(report.missing_values)) {
        const percentage = totalRows > 0 ? ((missingCount / totalRows) * 100).toFixed(2) : 0;
        const row = document.createElement('tr');
        row.className = 'bg-white border-b hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-6 py-4 font-mono">${column}</td>
          <td class="px-6 py-4">${missingCount}</td>
          <td class="px-6 py-4">${percentage}%</td>
        `;
        missingValuesTable.appendChild(row);
      }
    }

    pollStatus();
  </script>
{% endblock %}
