{% extends "core/base.html" %}
{% load crispy_forms_tags %}

{% block page_title %}Subir Nueva Fuente de Datos{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Main Upload Card -->
    <div class="bg-background-primary border border-border-default rounded-xl shadow-card p-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-foreground-default mb-2">
                Subir Nueva Fuente de Datos
            </h1>
            <p class="text-foreground-secondary">
                Agrega un nuevo conjunto de datos al proyecto <span class="font-medium text-foreground-default">"{{ project.name }}"</span>
            </p>
        </div>

        <form method="post" enctype="multipart/form-data" id="upload-form">
            {% csrf_token %}
            
            <!-- Form Fields Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Left Column: Basic Information -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-foreground-default mb-4">Información Básica</h3>
                    
                    <!-- Name Field -->
                    <div>
                        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-foreground-default mb-2">
                            Nombre de la Fuente de Datos
                        </label>
                        <input type="text" 
                               name="{{ form.name.name }}" 
                               id="{{ form.name.id_for_label }}"
                               value="{{ form.name.value|default:'' }}"
                               class="w-full px-3 py-2 border border-border-default rounded-lg bg-background-primary text-foreground-default placeholder-foreground-muted focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-colors"
                               placeholder="Ej. Datos de precipitación 2024"
                               required>
                        {% if form.name.errors %}
                            <div class="mt-1 text-sm text-danger-600">
                                {{ form.name.errors.0 }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Description Field -->
                    <div>
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-foreground-default mb-2">
                            Descripción (Opcional)
                        </label>
                        <textarea name="{{ form.description.name }}" 
                                  id="{{ form.description.id_for_label }}"
                                  rows="4"
                                  class="w-full px-3 py-2 border border-border-default rounded-lg bg-background-primary text-foreground-default placeholder-foreground-muted focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-colors resize-none"
                                  placeholder="Describe qué contiene este conjunto de datos...">{{ form.description.value|default:'' }}</textarea>
                        {% if form.description.errors %}
                            <div class="mt-1 text-sm text-danger-600">
                                {{ form.description.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Right Column: File Upload -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-foreground-default mb-4">Archivo de Datos</h3>
                    
                    <!-- Drag and Drop Zone -->
                    <div class="relative">
                        <input type="file" 
                               name="{{ form.file.name }}" 
                               id="{{ form.file.id_for_label }}"
                               accept=".csv,.xlsx,.xls"
                               class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                               required>
                        
                        <div id="drop-zone" 
                             class="relative border-2 border-dashed border-border-muted rounded-xl bg-background-secondary hover:bg-background-tertiary transition-all duration-200 p-8 text-center cursor-pointer">
                            
                            <!-- Default State -->
                            <div id="drop-zone-default" class="">
                                <svg class="mx-auto h-12 w-12 text-foreground-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <h4 class="text-lg font-medium text-foreground-default mb-2">
                                    Arrastra tu archivo aquí
                                </h4>
                                <p class="text-sm text-foreground-secondary mb-4">
                                    o <span class="text-brand-600 hover:text-brand-700 font-medium">haz clic para seleccionar</span>
                                </p>
                                <p class="text-xs text-foreground-muted">
                                    Formatos soportados: CSV, Excel (.xlsx, .xls)
                                </p>
                            </div>

                            <!-- Hover State -->
                            <div id="drop-zone-hover" class="hidden">
                                <svg class="mx-auto h-12 w-12 text-brand-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h4 class="text-lg font-medium text-brand-600 mb-2">
                                    ¡Suelta el archivo aquí!
                                </h4>
                                <p class="text-sm text-brand-500">
                                    Archivo listo para subir
                                </p>
                            </div>

                            <!-- File Selected State -->
                            <div id="drop-zone-selected" class="hidden">
                                <svg class="mx-auto h-12 w-12 text-success-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h4 class="text-lg font-medium text-success-600 mb-2">
                                    Archivo seleccionado
                                </h4>
                                <p id="selected-filename" class="text-sm text-foreground-default font-medium mb-2">
                                    <!-- File name will be inserted here -->
                                </p>
                                <p class="text-xs text-foreground-muted">
                                    Haz clic para cambiar archivo
                                </p>
                            </div>
                        </div>

                        {% if form.file.errors %}
                            <div class="mt-2 text-sm text-danger-600">
                                {{ form.file.errors.0 }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- File Info -->
                    <div class="bg-background-secondary border border-border-muted rounded-lg p-4">
                        <h4 class="text-sm font-medium text-foreground-default mb-2">Requisitos del archivo:</h4>
                        <ul class="text-xs text-foreground-secondary space-y-1">
                            <li class="flex items-center">
                                <svg class="w-3 h-3 text-success-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Formato CSV o Excel (.xlsx, .xls)
                            </li>
                            <li class="flex items-center">
                                <svg class="w-3 h-3 text-success-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Primera fila debe contener nombres de columnas
                            </li>
                            <li class="flex items-center">
                                <svg class="w-3 h-3 text-success-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Tamaño máximo: 50MB
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end space-x-3 pt-6 border-t border-border-muted">
                <a href="{% url 'projects:project_detail' pk=project.id %}" 
                   class="inline-flex items-center px-4 py-2 text-sm font-medium text-foreground-secondary bg-background-primary border border-border-default rounded-lg hover:bg-background-secondary hover:text-foreground-default transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Cancelar
                </a>
                <button type="submit" 
                        id="submit-button"
                        class="inline-flex items-center px-6 py-2 text-sm font-medium text-white bg-gray-800 dark:bg-gray-700 border border-transparent rounded-lg hover:bg-gray-900 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span id="submit-text">Subir Archivo</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'projects/js/datasource_form.js' %}"></script>
{% endblock %}