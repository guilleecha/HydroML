{% extends 'base.html' %}

{% block title %}Preparar Datos{% endblock %}

{% block content %}
    <h1>Herramienta de Preparación de Datos</h1>

    <div id="step1">
        <h3>Paso 1: Selecciona el Dataset a procesar</h3>
        <form method="GET" action="{% url 'prepare_data' %}">
            <select name="dataset_id" required style="padding: 8px; border-radius: 4px;">
                <option value="">-- Elige un dataset --</option>
                {% for ds in all_datasets %}
                    <option value="{{ ds.id }}" {% if selected_dataset.id == ds.id %}selected{% endif %}>
                        {{ ds.name }} (Proyecto: {{ ds.project.name }})
                    </option>
                {% endfor %}
            </select>
            <button type="submit" style="padding: 8px 12px;">Cargar Columnas</button>
        </form>
    </div>

    {% if error %}
        <p style="color: red; margin-top: 20px;"><strong>Error:</strong> {{ error }}</p>
    {% endif %}

    {% if selected_dataset and columns %}
        <hr style="margin: 30px 0;">
        <div id="step2">
            <h3>Paso 2: Asigna Roles y Prepara tu Dataset</h3>
            <p>Dataset seleccionado: <strong>{{ selected_dataset.name }}</strong></p>

            <form method="POST" id="data-prep-form" action="{% url 'prepare_data' %}">
                {% csrf_token %}
                <input type="hidden" name="dataset_id" value="{{ selected_dataset.id }}">

                <div style="display: flex; gap: 30px; margin-bottom: 20px;">
                    <div>
                        <label for="group_col"><b>Columna de Agrupación:</b></label><br>
                        <select name="group_col" id="group_col" required style="padding: 8px; margin-top: 5px;">
                            {% for col in columns %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="target_col"><b>Columna Objetivo:</b></label><br>
                        <select name="target_col" id="target_col" required style="padding: 8px; margin-top: 5px;">
                            {% for col in columns %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <hr>

                <h4>Previsualización de Datos</h4>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <button type="button" id="toggle-edit-btn">✏️ Editar Columnas</button>
                    <button type="button" id="undo-btn" style="display: none;">↩️ Deshacer</button>
                </div>

                <div id="table-container" style="overflow-x: auto;">
                    {{ data_preview_html|safe }}
                </div>

                <input type="hidden" name="removed_columns" id="removed_columns_input">

                <hr>

                <div>
                    <label for="new_dataset_name"><b>Nombre para el nuevo Dataset preparado:</b></label><br>
                    <input type="text" id="new_dataset_name" name="new_dataset_name"
                           value="{{ selected_dataset.name }} - Preparado"
                           required style="padding: 8px; margin-top: 5px; width: 80%;">
                </div>

                <button type="submit" style="margin-top: 20px;">Guardar y Continuar</button>
            </form>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // 2. Buscamos el div contenedor primero
                const tableContainer = document.getElementById('table-container');
                // Si el contenedor no existe, no hacemos nada.
                if (!tableContainer) return;

                // 3. Buscamos la tabla DENTRO del contenedor
                const table = tableContainer.querySelector('table');
                // Si la tabla no se encuentra, mostramos un error en consola y paramos.
                if (!table) {
                    console.error("Error: La tabla de previsualización no se encontró dentro de #table-container.");
                    return;
                }

                // El resto del script es el mismo, pero ahora sabemos que 'table' es válido.
                const toggleEditBtn = document.getElementById('toggle-edit-btn');
                const undoBtn = document.getElementById('undo-btn');
                const groupColSelect = document.getElementById('group_col');
                const targetColSelect = document.getElementById('target_col');
                const form = document.getElementById('data-prep-form');
                const removedColumnsInput = document.getElementById('removed_columns_input');
                let isEditMode = false;
                let removedColumnsHistory = [];

                function updateDeleteButtonsVisibility() {
                    const groupCol = groupColSelect.value;
                    const targetCol = targetColSelect.value;
                    const headers = table.querySelectorAll('thead th');
                    headers.forEach(th => {
                        const colName = th.dataset.colName || th.textContent.trim();
                        // Añadimos un data-col-name si no existe
                        if (!th.dataset.colName) {
                            th.dataset.colName = colName;
                        }
                        let deleteBtn = th.querySelector('.delete-col-btn');
                        if (!deleteBtn) {
                            deleteBtn = document.createElement('span');
                            deleteBtn.className = 'delete-col-btn';
                            deleteBtn.innerHTML = ' ❌';
                            deleteBtn.style.cursor = 'pointer';
                            deleteBtn.title = 'Eliminar Columna';
                            th.appendChild(deleteBtn);
                        }
                        if (isEditMode && colName !== groupCol && colName !== targetCol) {
                            deleteBtn.style.display = 'inline';
                        } else {
                            deleteBtn.style.display = 'none';
                        }
                    });
                }
                toggleEditBtn.addEventListener('click', () => {
                    isEditMode = !isEditMode;
                    toggleEditBtn.textContent = isEditMode ? '✅ Terminar Edición' : '✏️ Editar Columnas';
                    undoBtn.style.display = isEditMode && removedColumnsHistory.length > 0 ? 'inline-block' : 'none';
                    updateDeleteButtonsVisibility();
                });
                groupColSelect.addEventListener('change', updateDeleteButtonsVisibility);
                targetColSelect.addEventListener('change', updateDeleteButtonsVisibility);
                table.addEventListener('click', function(e) {
                    if (e.target && e.target.classList.contains('delete-col-btn')) {
                        const th = e.target.parentElement;
                        const colName = th.dataset.colName;
                        const colIndex = Array.from(th.parentNode.children).indexOf(th);
                        th.style.display = 'none';
                        table.querySelectorAll(`tbody tr`).forEach(row => {
                            if(row.children[colIndex]) row.children[colIndex].style.display = 'none';
                        });
                        removedColumnsHistory.push({name: colName, index: colIndex});
                        undoBtn.style.display = 'inline-block';
                    }
                });
                undoBtn.addEventListener('click', () => {
                    if (removedColumnsHistory.length > 0) {
                        const lastRemoved = removedColumnsHistory.pop();
                        const header = table.querySelector(`thead th[data-col-name="${lastRemoved.name}"]`);
                        if(header) header.style.display = '';
                        table.querySelectorAll(`tbody tr`).forEach(row => {
                           if(row.children[lastRemoved.index]) row.children[lastRemoved.index].style.display = '';
                        });
                    }
                    if (removedColumnsHistory.length === 0) {
                        undoBtn.style.display = 'none';
                    }
                });
                form.addEventListener('submit', () => {
                    const finalRemovedColumns = removedColumnsHistory.map(item => item.name);
                    removedColumnsInput.value = JSON.stringify(finalRemovedColumns);
                });
            });
        </script>
    {% endif %}
{% endblock %}